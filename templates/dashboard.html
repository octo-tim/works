{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">ëŒ€ì‹œë³´ë“œ</h2>
    <div class="flex space-x-2">
        <!-- Add Task Modal Trigger -->
        <button onclick="document.getElementById('taskModal').classList.remove('hidden')"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm text-sm font-medium">
            + ìƒˆ ì—…ë¬´
        </button>
    </div>
</div>

<!-- Goals Section -->
<div class="mb-6 space-y-4">
    <!-- Annual Goal -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl shadow-lg p-6 text-white">
        <h2 class="text-xl font-bold mb-2">2026 ì „ì‚¬ ëª©í‘œ</h2>
        <form action="/goals/annual" method="post" class="flex gap-2">
            <input type="hidden" name="year" value="2026">
            <input type="text" name="content" value="{{ goals.annual_2026.content if goals.annual_2026 else '' }}"
                class="flex-1 bg-white/10 border border-white/20 rounded px-3 py-2 text-white placeholder-blue-200 outline-none focus:bg-white/20 transition"
                placeholder="2026ë…„ ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onblur="this.form.submit()">
        </form>
    </div>

    <!-- Monthly Goals Summary (Selected Month) -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-gray-800">ì›”ë³„ ëª©í‘œ í˜„í™©</h3>
            <!-- Month Selector -->
            <form action="/" method="get">
                <select name="target_month" onchange="this.form.submit()"
                    class="border-none bg-gray-100 rounded-lg px-3 py-1 text-sm font-bold text-gray-700 cursor-pointer focus:ring-0">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if selected_month==m %}selected{% endif %}>{{ m }}ì›”</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- System Division -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-100 flex flex-col gap-3">
                <h4 class="text-xs font-bold text-blue-600 mb-1 border-b border-blue-200 pb-1">ì‹œìŠ¤í…œì‚¬ì—…ë¶€</h4>
                <div>
                    <span class="text-xs text-gray-500 block">ì—…ë¬´ëª©í‘œ</span>
                    <p class="text-gray-800 font-medium text-sm">
                        {{ goals.monthly_obj_system.content if goals.monthly_obj_system else '-' }}
                    </p>
                </div>
                <div class="flex gap-4">
                    <div>
                        <span class="text-xs text-gray-500 block">ë§¤ì¶œëª©í‘œ</span>
                        <p class="text-gray-800 font-bold text-sm">
                            {{ goals.monthly_perf_system.goal_value if goals.monthly_perf_system else '-' }}
                        </p>
                    </div>
                    <div>
                        <span class="text-xs text-gray-500 block">ì‹¤ì </span>
                        <p class="text-gray-800 font-bold text-sm">
                            {{ goals.monthly_perf_system.actual_value if goals.monthly_perf_system else '-' }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Distribution Division -->
            <div class="bg-pink-50 rounded-lg p-4 border border-pink-100 flex flex-col gap-3">
                <h4 class="text-xs font-bold text-pink-600 mb-1 border-b border-pink-200 pb-1">ìœ í†µì‚¬ì—…ë¶€</h4>
                <div>
                    <span class="text-xs text-gray-500 block">ì—…ë¬´ëª©í‘œ</span>
                    <p class="text-gray-800 font-medium text-sm">
                        {{ goals.monthly_obj_dist.content if goals.monthly_obj_dist else '-' }}
                    </p>
                </div>
                <div class="flex gap-4">
                    <div>
                        <span class="text-xs text-gray-500 block">ë§¤ì¶œëª©í‘œ</span>
                        <p class="text-gray-800 font-bold text-sm">
                            {{ goals.monthly_perf_dist.goal_value if goals.monthly_perf_dist else '-' }}
                        </p>
                    </div>
                    <div>
                        <span class="text-xs text-gray-500 block">ì‹¤ì </span>
                        <p class="text-gray-800 font-bold text-sm">
                            {{ goals.monthly_perf_dist.actual_value if goals.monthly_perf_dist else '-' }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<form method="get" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-wrap gap-4 items-end">
    <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">ì‚¬ì—…ë¶€</label>
        <select name="department" class="border rounded px-3 py-2 text-sm w-40" onchange="this.form.submit()">
            <option value="">ì „ì²´ ì‚¬ì—…ë¶€</option>
            <option value="System" {% if selected_department=='System' %}selected{% endif %}>ì‹œìŠ¤í…œì‚¬ì—…ë¶€</option>
            <option value="Distribution" {% if selected_department=='Distribution' %}selected{% endif %}>ìœ í†µì‚¬ì—…ë¶€</option>
        </select>
    </div>
    <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">ë‹´ë‹¹ì</label>
        <select name="assignee_id" class="border rounded px-3 py-2 text-sm w-40" onchange="this.form.submit()">
            <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
            {% for u in users %}
            <option value="{{ u.id }}" {% if selected_assignee==u.id %}selected{% endif %}>{{ u.username }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">ê±°ë˜ì²˜ (í”„ë¡œì íŠ¸)</label>
        <select name="client_id" class="border rounded px-3 py-2 text-sm w-40" onchange="this.form.submit()">
            <option value="">ì „ì²´ ê±°ë˜ì²˜</option>
            {% for c in clients %}
            <option value="{{ c.id }}" {% if selected_client==c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label class="block text-xs font-semibold text-gray-500 mb-1">ì—…ë¬´ ìœ í˜•</label>
        <select name="category_id" class="border rounded px-3 py-2 text-sm w-40" onchange="this.form.submit()">
            <option value="">ì „ì²´ ìœ í˜•</option>
            {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category==c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="pb-0.5">
        <a href="/" class="text-sm text-gray-500 hover:text-gray-700 underline">ì´ˆê¸°í™”</a>
    </div>
</form>

<!-- Kanban Board -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full pb-10">
    <!-- Todo Column -->
    <div class="bg-gray-50 rounded-xl p-4 flex flex-col h-full border border-gray-200">
        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center">
            <span class="w-2.5 h-2.5 rounded-full bg-gray-400 mr-2"></span>
            <h3 class="font-bold text-gray-800">ì˜ˆì •</h3>
            <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ tasks_todo|length }}</span>
        </div>
        <div class="space-y-3 overflow-y-auto flex-1 pr-1">
            {% for task in tasks_todo %}
            {% include 'task_card.html' %}
            {% endfor %}
        </div>
    </div>

    <!-- In Progress Column -->
    <div class="bg-blue-50 rounded-xl p-4 flex flex-col h-full border border-blue-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-blue-800">ì§„í–‰ ì¤‘</h3>
            <span class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full">{{ tasks_inprogress|length }}</span>
        </div>
        <div class="space-y-3 overflow-y-auto flex-1 pr-1">
            {% for task in tasks_inprogress %}
            {% include 'task_card.html' %}
            {% endfor %}
        </div>
    </div>

    <!-- Done Column -->
    <div class="bg-green-50 rounded-xl p-4 flex flex-col h-full border border-green-100">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-green-800">ì™„ë£Œ</h3>
            <span class="bg-green-200 text-green-800 text-xs px-2 py-1 rounded-full">{{ tasks_done|length }}</span>
        </div>
        <div class="space-y-3 overflow-y-auto flex-1 pr-1">
            {% for task in tasks_done %}
            {% include 'task_card.html' %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Calendar Section -->
<div class="mt-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-10">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">ì¼ì • ìº˜ë¦°ë”</h3>
    </div>
    <div id='calendar' class="h-[600px]"></div>
</div>

<!-- Create Task Modal -->
<div id="taskModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ìƒˆ ì—…ë¬´ ë§Œë“¤ê¸°</h3>
            <button onclick="document.getElementById('taskModal').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form action="/tasks" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ëª…</label>
                <input type="text" name="title" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                    <select name="status" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="Todo">ì˜ˆì •</option>
                        <option value="In Progress">ì§„í–‰ ì¤‘</option>
                        <option value="Done">ì¢…ë£Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼</label>
                    <input type="date" name="start_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë§ˆê°ì¼</label>
                    <input type="date" name="due_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì (ë‹¤ì¤‘ ì„ íƒ: Ctrl/Cmd + Click)</label>
                    <select name="assignee_ids" multiple class="w-full border rounded-lg px-3 py-2 text-sm h-24">
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ ìœ í˜•</label>
                    <select name="category_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="0">ì—†ìŒ</option>
                        {% for c in categories %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸</label>
                <select name="project_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                    <option value="0">Inbox (í”„ë¡œì íŠ¸ ì—†ìŒ)</option>
                    {% for p in projects %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit"
                class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ìƒì„±</button>
        </form>
    </div>
</div>

<!-- Edit Task Modal -->
<div id="editTaskModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ì—…ë¬´ ìˆ˜ì •</h3>
            <button onclick="document.getElementById('editTaskModal').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form id="editTaskForm" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ëª…</label>
                <input type="text" name="title" id="edit_title" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" id="edit_description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                    <select name="status" id="edit_status" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="Todo">ì˜ˆì •</option>
                        <option value="In Progress">ì§„í–‰ ì¤‘</option>
                        <option value="Done">ì¢…ë£Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼</label>
                    <input type="date" name="start_date" id="edit_start_date"
                        class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë§ˆê°ì¼</label>
                    <input type="date" name="due_date" id="edit_due_date"
                        class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì (ë‹¤ì¤‘ ì„ íƒ)</label>
                    <select name="assignee_ids" id="edit_assignee_ids" multiple
                        class="w-full border rounded-lg px-3 py-2 text-sm h-24">
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ì—…ë¶€</label>
                    <select name="department" id="edit_department" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="">ë¯¸ì§€ì •</option>
                        <option value="System">ì‹œìŠ¤í…œì‚¬ì—…ë¶€</option>
                        <option value="Distribution">ìœ í†µì‚¬ì—…ë¶€</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ ìœ í˜•</label>
                    <select name="category_id" id="edit_category_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="0">ì—†ìŒ</option>
                        {% for c in categories %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸</label>
                    <select name="project_id" id="edit_project_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="0">Inbox (í”„ë¡œì íŠ¸ ì—†ìŒ)</option>
                        {% for p in projects %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="flex gap-2">
                <button type="button" onclick="deleteTask()"
                    class="w-1/3 bg-red-100 text-red-600 font-bold py-2 rounded-lg hover:bg-red-200 transition">ì‚­ì œ</button>
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ì €ì¥</button>
            </div>
        </form>

        <!-- Delete Form (Hidden) -->
        <form id="deleteTaskForm" method="post" class="hidden"></form>

        <!-- Divider -->
        <hr class="my-6 border-gray-200">

        <!-- File Upload Section -->
        <div>
            <h4 class="font-bold text-gray-800 mb-2">ì²¨ë¶€ íŒŒì¼</h4>
            <ul id="taskFileList" class="mb-4 space-y-2 text-sm text-gray-600">
                <!-- Dynamically populated -->
            </ul>

            <form id="taskUploadForm" method="post" enctype="multipart/form-data" class="flex gap-2">
                <input type="file" name="file" required
                    class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button type="submit"
                    class="bg-gray-800 text-white text-xs px-3 py-2 rounded hover:bg-gray-700">ì—…ë¡œë“œ</button>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditModal(id, title, description, status, department, assignee_ids, start_date, due_date, project_id, category_id, filenames, filepaths) {
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_status').value = status;
        document.getElementById('edit_department').value = department;

        // Handle Multiple Select
        const select = document.getElementById('edit_assignee_ids');
        // Reset
        Array.from(select.options).forEach(o => o.selected = false);
        // Select matching
        if (assignee_ids) {
            Array.from(select.options).forEach(option => {
                option.selected = assignee_ids.includes(parseInt(option.value));
            });
        }

        document.getElementById('edit_start_date').value = start_date;
        document.getElementById('edit_due_date').value = due_date;
        document.getElementById('edit_project_id').value = project_id;
        document.getElementById('edit_category_id').value = category_id;

        document.getElementById('editTaskForm').action = "/tasks/" + id + "/update";
        document.getElementById('taskUploadForm').action = "/tasks/" + id + "/upload";
        document.getElementById('deleteTaskForm').action = "/tasks/" + id + "/delete";

        // Populate File List
        const fileList = document.getElementById('taskFileList');
        fileList.innerHTML = '';

        if (filenames && filenames.length > 0) {
            filenames.forEach((name, index) => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = filepaths[index]; // Use filepath
                link.textContent = name;
                link.target = "_blank";
                link.className = "text-blue-600 hover:underline flex items-center";
                link.innerHTML = `<span class="mr-2">ğŸ“„</span> ${name}`;
                li.appendChild(link);
                fileList.appendChild(li);
            });
        } else {
            fileList.innerHTML = '<li class="text-gray-400 italic">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        }

        document.getElementById('editTaskModal').classList.remove('hidden');
    }

    function deleteTask() {
        if (confirm('ì •ë§ ì´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            document.getElementById('deleteTaskForm').submit();
        }
    }
</script>
<!-- FullCalendar CDN -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko', // Korean locale
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,dayGridWeek,listWeek'
            },
            events: {{ calendar_events | tojson }},
        eventClick: function (info) {
            if (info.event.url && info.event.url.startsWith("javascript:")) {
                info.jsEvent.preventDefault(); // Prevent navigating to "javascript:..."
                eval(info.event.url); // Execute the JS
            }
        },
        eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        meridiem: false
    }
        });
    calendar.render();
    });
</script>
{% endblock %}