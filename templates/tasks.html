{% extends "base.html" %}

{% block content %}
<div class="h-full flex flex-col">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">ì—…ë¬´ ê´€ë¦¬</h2>
        <button onclick="document.getElementById('taskModal').classList.remove('hidden')"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm text-sm font-medium">
            + ìƒˆ ì—…ë¬´
        </button>
    </div>

    <div class="flex-1 overflow-y-auto pr-2 space-y-8">

        <!-- Scheduled (Todo) Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-gray-400 mr-2"></span>
                <h3 class="font-bold text-gray-800">ì˜ˆì •</h3>
                <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ scheduled|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">ì—…ë¬´ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸/ê±°ë˜ì²˜</th>
                            <th scope="col" class="px-6 py-3">ë‹´ë‹¹ì/ë§ˆê°ì¼</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in scheduled %}
                        <tr class="bg-white border-b hover:bg-gray-50 cursor-pointer" onclick="openEditModal('{{ t.id }}', '{{ t.title }}', '{{ t.description or '' }}', '{{ t.status }}', '{{ t.assignee_id or 0 }}', '{{ t.start_date or '' }}', '{{ t.due_date or '' }}', '{{ t.project_id or 0 }}', '{{ t.category_id or 0 }}', '{{ t.department or '' }}', [
                            {%- for f in t.files -%}
                                '{{ f.filename }}'{%- if not loop.last -%}, {%- endif -%}
                            {%- endfor -%}
                            ], [
                            {%- for f in t.files -%}
                                '{{ f.filepath }}'{%- if not loop.last -%}, {%- endif -%}
                            {%- endfor -%}
                            ])">
                            <td class="px-6 py-4 font-medium text-gray-900">{{ t.title }}</td>
                            <td class="px-6 py-4">
                                {% if t.department == 'System' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif t.department == 'Distribution' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if t.project %}
                                <span
                                    class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold mb-1 block w-fit">{{
                                    t.project.name }}</span>
                                {% endif %}
                                {% if t.project and t.project.client %}
                                <span class="text-xs text-gray-500">{{ t.project.client.name }}</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span class="font-medium text-gray-800">{{ t.assignee.username if t.assignee else
                                        'ë¯¸ì§€ì •' }}</span>
                                    <span class="text-xs text-gray-500">{{ t.due_date }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ t.description or '' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">ì˜ˆì •ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- In Progress Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-blue-50 px-6 py-3 border-b border-blue-100 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-blue-500 mr-2"></span>
                <h3 class="font-bold text-blue-800">ì§„í–‰ ì¤‘</h3>
                <span class="ml-2 bg-blue-200 text-blue-800 text-xs px-2 py-0.5 rounded-full">{{ inprogress|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">ì—…ë¬´ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸/ê±°ë˜ì²˜</th>
                            <th scope="col" class="px-6 py-3">ë‹´ë‹¹ì/ë§ˆê°ì¼</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in inprogress %}
                        <tr class="bg-white border-b hover:bg-gray-50 cursor-pointer" onclick="openEditModal('{{ t.id }}', '{{ t.title }}', '{{ t.description or '' }}', '{{ t.status }}', '{{ t.assignee_id or 0 }}', '{{ t.start_date or '' }}', '{{ t.due_date or '' }}', '{{ t.project_id or 0 }}', '{{ t.category_id or 0 }}', '{{ t.department or '' }}', [
                            {%- for f in t.files -%}
                                '{{ f.filename }}'{%- if not loop.last -%}, {%- endif -%}
                            {%- endfor -%}
                            ], [
                            {%- for f in t.files -%}
                                '{{ f.filepath }}'{%- if not loop.last -%}, {%- endif -%}
                            {%- endfor -%}
                            ])">
                            <td class="px-6 py-4 font-medium text-gray-900">{{ t.title }}</td>
                            <td class="px-6 py-4">
                                {% if t.department == 'System' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif t.department == 'Distribution' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if t.project %}
                                <span
                                    class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold mb-1 block w-fit">{{
                                    t.project.name }}</span>
                                {% endif %}
                                {% if t.project and t.project.client %}
                                <span class="text-xs text-gray-500">{{ t.project.client.name }}</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span class="font-medium text-gray-800">{{ t.assignee.username if t.assignee else
                                        'ë¯¸ì§€ì •' }}</span>
                                    <span class="text-xs text-gray-500">{{ t.due_date }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ t.description or '' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">ì§„í–‰ ì¤‘ì¸ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Done Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-green-50 px-6 py-3 border-b border-green-100 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-green-500 mr-2"></span>
                <h3 class="font-bold text-green-800">ì¢…ë£Œ</h3>
                <span class="ml-2 bg-green-200 text-green-800 text-xs px-2 py-0.5 rounded-full">{{ completed|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">ì—…ë¬´ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸/ê±°ë˜ì²˜</th>
                            <th scope="col" class="px-6 py-3">ë‹´ë‹¹ì/ë§ˆê°ì¼</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in completed %}
                        <tr class="bg-white border-b hover:bg-gray-50 cursor-pointer" onclick="openEditModal('{{ t.id }}', '{{ t.title }}', '{{ t.description or '' }}', '{{ t.status }}', '{{ t.assignee_id or 0 }}', '{{ t.start_date or '' }}', '{{ t.due_date or '' }}', '{{ t.project_id or 0 }}', '{{ t.category_id or 0 }}', '{{ t.department or '' }}', [
                            {%- for f in t.files -%}
                                '{{ f.filename }}'{%- if not loop.last -%}, {%- endif -%}
                            {%- endfor -%}
                            ], [
                            {%- for f in t.files -%}
                                '{{ f.filepath }}'{%- if not loop.last -%}, {%- endif -%}
                            {%- endfor -%}
                            ])">
                            <td class="px-6 py-4 font-medium text-gray-900">{{ t.title }}</td>
                            <td class="px-6 py-4">
                                {% if t.department == 'System' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif t.department == 'Distribution' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                {% if t.project %}
                                <span
                                    class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold mb-1 block w-fit">{{
                                    t.project.name }}</span>
                                {% endif %}
                                {% if t.project and t.project.client %}
                                <span class="text-xs text-gray-500">{{ t.project.client.name }}</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span class="font-medium text-gray-800">{{ t.assignee.username if t.assignee else
                                        'ë¯¸ì§€ì •' }}</span>
                                    <span class="text-xs text-gray-500">{{ t.due_date }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ t.description or '' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">ì¢…ë£Œëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Create Task Modal -->
<div id="taskModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ìƒˆ ì—…ë¬´ ë§Œë“¤ê¸°</h3>
            <button onclick="document.getElementById('taskModal').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form action="/tasks" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ëª…</label>
                <input type="text" name="title" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                    <select name="status" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="Todo">ì˜ˆì •</option>
                        <option value="In Progress">ì§„í–‰ ì¤‘</option>
                        <option value="Done">ì¢…ë£Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼</label>
                    <input type="date" name="start_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë§ˆê°ì¼</label>
                    <input type="date" name="due_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì</label>
                    <select name="assignee_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="0">ë¯¸ì§€ì •</option>
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ ìœ í˜•</label>
                    <select name="category_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="0">ì—†ìŒ</option>
                        {% for c in categories %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸</label>
                <select name="project_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                    <option value="0">Inbox (í”„ë¡œì íŠ¸ ì—†ìŒ)</option>
                    {% for p in projects %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit"
                class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ìƒì„±</button>
        </form>
    </div>
</div>

<!-- Edit Task Modal -->
<div id="editTaskModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ì—…ë¬´ ìˆ˜ì •</h3>
            <button onclick="document.getElementById('editTaskModal').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form id="editTaskForm" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ëª…</label>
                <input type="text" name="title" id="edit_title" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" id="edit_description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                    <select name="status" id="edit_status" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="Todo">ì˜ˆì •</option>
                        <option value="In Progress">ì§„í–‰ ì¤‘</option>
                        <option value="Done">ì¢…ë£Œ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì¼</label>
                    <input type="date" name="start_date" id="edit_start_date"
                        class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë§ˆê°ì¼</label>
                    <input type="date" name="due_date" id="edit_due_date"
                        class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì</label>
                    <select name="assignee_id" id="edit_assignee_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="0">ë¯¸ì§€ì •</option>
                        {% for u in users %}
                        <option value="{{ u.id }}">{{ u.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì—…ë¬´ ìœ í˜•</label>
                    <select name="category_id" id="edit_category_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="0">ì—†ìŒ</option>
                        {% for c in categories %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸</label>
                <select name="project_id" id="edit_project_id" class="w-full border rounded-lg px-3 py-2 text-sm">
                    <option value="0">Inbox (í”„ë¡œì íŠ¸ ì—†ìŒ)</option>
                    {% for p in projects %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="flex gap-2">
                <button type="button" onclick="deleteTask()"
                    class="w-1/3 bg-red-100 text-red-600 font-bold py-2 rounded-lg hover:bg-red-200 transition">ì‚­ì œ</button>
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ì €ì¥</button>
            </div>
        </form>

        <!-- Delete Form (Hidden) -->
        <form id="deleteTaskForm" method="post" class="hidden"></form>

        <!-- Divider -->
        <hr class="my-6 border-gray-200">

        <!-- File Upload Section -->
        <div>
            <h4 class="font-bold text-gray-800 mb-2">ì²¨ë¶€ íŒŒì¼</h4>
            <ul id="taskFileList" class="mb-4 space-y-2 text-sm text-gray-600">
                <!-- Dynamically populated -->
            </ul>

            <form id="taskUploadForm" method="post" enctype="multipart/form-data" class="flex gap-2">
                <input type="file" name="file" required
                    class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button type="submit"
                    class="bg-gray-800 text-white text-xs px-3 py-2 rounded hover:bg-gray-700">ì—…ë¡œë“œ</button>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditModal(id, title, description, status, assignee_id, start_date, due_date, project_id, category_id, department, filenames, filepaths) {
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_status').value = status;
        document.getElementById('edit_assignee_id').value = assignee_id;
        document.getElementById('edit_start_date').value = start_date;
        document.getElementById('edit_due_date').value = due_date;
        document.getElementById('edit_project_id').value = project_id;
        document.getElementById('edit_category_id').value = category_id;
        document.getElementById('edit_department').value = department;

        document.getElementById('editTaskForm').action = "/tasks/" + id + "/update";
        document.getElementById('taskUploadForm').action = "/tasks/" + id + "/upload";
        document.getElementById('deleteTaskForm').action = "/tasks/" + id + "/delete";

        // Populate File List
        const fileList = document.getElementById('taskFileList');
        fileList.innerHTML = '';

        if (filenames && filenames.length > 0) {
            filenames.forEach((name, index) => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = filepaths[index]; // Use filepath
                link.textContent = name;
                link.target = "_blank";
                link.className = "text-blue-600 hover:underline flex items-center";
                link.innerHTML = `<span class="mr-2">ğŸ“„</span> ${name}`;
                li.appendChild(link);
                fileList.appendChild(li);
            });
        } else {
            fileList.innerHTML = '<li class="text-gray-400 italic">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        }

        document.getElementById('editTaskModal').classList.remove('hidden');
    }

    function deleteTask() {
        if (confirm('ì •ë§ ì´ ì—…ë¬´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            document.getElementById('deleteTaskForm').submit();
        }
    }
</script>
{% endblock %}