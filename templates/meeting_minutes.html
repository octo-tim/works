{% extends "base.html" %}

{% block content %}
<div class="h-full flex flex-col">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">íšŒì˜ë¡</h2>
        <div class="flex gap-2">
            <button onclick="deleteSelected()" id="deleteBtn" style="display: none;"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded shadow-sm text-sm font-medium transition">
                ì„ íƒ ì‚­ì œ
            </button>
            <button onclick="document.getElementById('createModal').classList.remove('hidden')"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm text-sm font-medium">
                + íšŒì˜ë¡ ì‘ì„±
            </button>
        </div>
    </div>

    <!-- Meeting Minutes List -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex-1 flex flex-col">
        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center">
            <h3 class="font-bold text-gray-800">íšŒì˜ ëª©ë¡</h3>
            <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ minutes|length }}</span>
        </div>
        <div class="overflow-y-auto flex-1">
            <form id="bulkDeleteForm" action="/meeting_minutes/delete_bulk" method="post">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 w-10">
                                <input type="checkbox" onclick="toggleAll(this)"
                                    class="rounded text-blue-600 focus:ring-blue-500">
                            </th>
                            <th scope="col" class="px-6 py-3 w-32">ë‚ ì§œ</th>
                            <th scope="col" class="px-6 py-3">ì£¼ì œ</th>
                            <th scope="col" class="px-6 py-3">ì¥ì†Œ</th>
                            <th scope="col" class="px-6 py-3">ì°¸ì„ì</th>
                            <th scope="col" class="px-6 py-3 w-32">ì‘ì„±ì</th>
                            <th scope="col" class="px-6 py-3 w-20"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in minutes %}
                        <tr class="bg-white border-b hover:bg-gray-50 cursor-pointer">
                            <td class="px-6 py-4" onclick="event.stopPropagation()">
                                <input type="checkbox" name="minute_ids" value="{{ m.id }}"
                                    class="minute-checkbox rounded text-blue-600 focus:ring-blue-500"
                                    onchange="updateDeleteBtn()">
                            </td>
                            <td class="px-6 py-4 font-medium text-gray-900"
                                onclick="window.location.href='/meeting_minutes/{{ m.id }}'">{{
                                m.date.strftime('%Y-%m-%d') }}</td>
                            <td class="px-6 py-4 font-bold text-gray-800"
                                onclick="window.location.href='/meeting_minutes/{{ m.id }}'">{{ m.topic }}</td>
                            <td class="px-6 py-4" onclick="window.location.href='/meeting_minutes/{{ m.id }}'">{{
                                m.location or '-' }}</td>
                            <td class="px-6 py-4 truncate max-w-xs"
                                onclick="window.location.href='/meeting_minutes/{{ m.id }}'">{{ m.attendees or '-' }}
                            </td>
                            <td class="px-6 py-4" onclick="window.location.href='/meeting_minutes/{{ m.id }}'">
                                {% if m.writer %}
                                <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">{{
                                    m.writer.username }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right"
                                onclick="window.location.href='/meeting_minutes/{{ m.id }}'">
                                <span class="text-blue-600">View &rarr;</span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="px-6 py-10 text-center text-gray-400">
                                <p class="mb-2 text-lg">ë“±ë¡ëœ íšŒì˜ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p class="text-sm">ìƒˆë¡œìš´ íšŒì˜ë¡ì„ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleAll(source) {
        checkboxes = document.getElementsByName('minute_ids');
        for (var i = 0, n = checkboxes.length; i < n; i++) {
            checkboxes[i].checked = source.checked;
        }
        updateDeleteBtn();
    }

    function updateDeleteBtn() {
        const checkboxes = document.getElementsByName('minute_ids');
        let checkedCount = 0;
        for (var i = 0; i < checkboxes.length; i++) {
            if (checkboxes[i].checked) checkedCount++;
        }
        const btn = document.getElementById('deleteBtn');
        if (checkedCount > 0) {
            btn.style.display = 'block';
            btn.innerText = `ì„ íƒ ì‚­ì œ (${checkedCount})`;
        } else {
            btn.style.display = 'none';
        }
    }

    function deleteSelected() {
        if (confirm('ì„ íƒí•œ íšŒì˜ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            document.getElementById('bulkDeleteForm').submit();
        }
    }
</script>

<!-- Create Modal -->
<div id="createModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
        <button onclick="document.getElementById('createModal').classList.add('hidden')"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <h3 class="text-xl font-bold text-gray-800 mb-6">ìƒˆ íšŒì˜ë¡ ì‘ì„±</h3>

        <form action="/meeting_minutes" method="post" enctype="multipart/form-data" class="space-y-4" id="createForm"
            onsubmit="prepareSubmit()">
            <!-- AI Analysis Section -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
                    <span>âš¡ AI íšŒì˜ë¡ ë¶„ì„</span>
                    <span class="text-xs font-normal text-white bg-purple-600 px-2 py-0.5 rounded">BETA</span>
                </label>
                <div class="relative">
                    <textarea id="rawNotes" rows="4"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none mb-2"
                        placeholder="íšŒì˜ ë…¹ì·¨ë¡ì´ë‚˜ ë©”ëª¨ë¥¼ ì´ê³³ì— ë¶™ì—¬ë„£ê³  'AI ë¶„ì„'ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. ìš”ì•½ê³¼ ì—…ë¬´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤."></textarea>

                    <button type="button" onclick="analyzeMeeting()"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 flex items-center gap-2 transition w-full justify-center">
                        <svg id="aiIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span id="aiBtnText">AI ìš”ì•½ ë° ë¶„ì„ ì‹¤í–‰</span>
                    </button>

                    <!-- Analysis Result Preview -->
                    <div id="aiResult" class="hidden mt-4 border-t pt-4">
                        <div class="space-y-3">
                            <div>
                                <h4 class="text-sm font-bold text-gray-700 mb-1">ğŸ“ ìš”ì•½ ë¯¸ë¦¬ë³´ê¸°</h4>
                                <div id="previewSummary"
                                    class="text-xs text-gray-600 bg-white p-2 rounded border max-h-32 overflow-y-auto">
                                </div>
                            </div>

                            <div>
                                <h4 class="text-sm font-bold text-gray-700 mb-1">âœ… ë°œê²¬ëœ ì—…ë¬´ (ì²´í¬í•˜ì—¬ ìë™ìƒì„±)</h4>
                                <div id="previewTasks" class="space-y-1 max-h-40 overflow-y-auto">
                                    <!-- Tasks checkboxes will go here -->
                                </div>
                            </div>

                            <button type="button" onclick="applyAIResult()"
                                class="w-full bg-blue-100 text-blue-700 py-2 rounded-lg text-sm font-bold hover:bg-blue-200 transition mt-2">
                                ê²°ê³¼ ì ìš©í•˜ê¸° (ë³¸ë¬¸ì— ì‚½ì…)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">íšŒì˜ ì£¼ì œ</label>
                <input type="text" name="topic" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <input type="hidden" name="tasks_data" id="tasksDataInput">

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                    <input type="date" name="date_str" required
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œê°„</label>
                    <input type="text" name="time" placeholder="ì˜ˆ: 14:00 - 16:00"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">íšŒì˜ì¥ì†Œ</label>
                    <input type="text" name="location" placeholder="ì˜ˆ: ëŒ€íšŒì˜ì‹¤"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì°¸ì„ì</label>
                    <input type="text" name="attendees" placeholder="ì˜ˆ: ê¹€íŒ€ì¥, ì´ëŒ€ë¦¬"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">íšŒì˜ ë‚´ìš©</label>
                <textarea name="content" rows="10" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono"
                    placeholder="- íšŒì˜ ë‚´ìš©ì„ ìƒì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì²¨ë¶€ íŒŒì¼</label>
                <input type="file" name="files" multiple
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>

            <div class="pt-4 flex justify-end gap-2">
                <button type="button" onclick="document.getElementById('createModal').classList.add('hidden')"
                    class="bg-gray-100 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                <button type="submit"
                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">ì €ì¥í•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Set default date to today
    document.querySelector('input[name="date_str"]').valueAsDate = new Date();

    let aiAnalysisData = null;

    async function analyzeMeeting() {
        const rawText = document.getElementById('rawNotes').value;
        const btnText = document.getElementById('aiBtnText');
        const icon = document.getElementById('aiIcon');

        if (!rawText.trim()) {
            alert('ë¶„ì„í•  íšŒì˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // Loading State
        btnText.innerText = 'ë¶„ì„ ì¤‘...';
        icon.classList.add('animate-spin');

        try {
            const response = await fetch('/api/minutes/ai-analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: rawText })
            });

            const result = await response.json();

            if (response.ok) {
                aiAnalysisData = result;
                showPreview(result);
            } else {
                alert('ë¶„ì„ ì‹¤íŒ¨: ' + (result.detail || 'ì˜¤ë¥˜ ë°œìƒ'));
            }
        } catch (e) {
            console.error(e);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            btnText.innerText = 'AI ìš”ì•½ ë° ë¶„ì„ ì‹¤í–‰';
            icon.classList.remove('animate-spin');
        }
    }

    function showPreview(data) {
        document.getElementById('aiResult').classList.remove('hidden');

        // 1. Summary
        const summaryHtml = `
            <div class="mb-2"><strong>ğŸ“Œ ìš”ì•½:</strong><br>${data.summary || '-'}</div>
            <div class="mb-2"><strong>ğŸ›‘ ê²°ì •ì‚¬í•­:</strong><br>${(data.decisions || []).join('<br> - ')}</div>
            <div><strong>âš ï¸ ë¦¬ìŠ¤í¬:</strong><br>${(data.risks || []).join('<br> - ')}</div>
        `;
        document.getElementById('previewSummary').innerHTML = summaryHtml;

        // 2. Tasks
        const tasksContainer = document.getElementById('previewTasks');
        tasksContainer.innerHTML = '';
        if (data.action_items && data.action_items.length > 0) {
            data.action_items.forEach((task, idx) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 p-2 border rounded bg-white hover:bg-gray-50';
                div.innerHTML = `
                    <input type="checkbox" id="task_chk_${idx}" class="task-checkbox w-4 h-4 text-purple-600 rounded" checked>
                    <div class="flex-1 text-xs">
                        <div class="font-bold text-gray-800">${task.title}</div>
                        <div class="text-gray-500">
                            ë‹´ë‹¹: <span class="text-blue-600 font-medium">${task.assignee_name || 'ë¯¸ì§€ì •'}</span> | 
                            ê¸°í•œ: ${task.due_date || 'ë¯¸ì •'} | 
                            ìš°ì„ ìˆœìœ„: ${task.priority || 'Normal'}
                        </div>
                    </div>
                `;
                tasksContainer.appendChild(div);
            });
        } else {
            tasksContainer.innerHTML = '<div class="text-xs text-gray-400">ë°œê²¬ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    function applyAIResult() {
        if (!aiAnalysisData) return;

        // 1. Apply to Content
        const contentArea = document.querySelector('textarea[name="content"]');
        const formattedContent = `
## ğŸ“Œ íšŒì˜ ìš”ì•½
${aiAnalysisData.summary}

## ğŸ›‘ ê²°ì •ì‚¬í•­
${(aiAnalysisData.decisions || []).map(d => `- ${d}`).join('\n')}

## âš ï¸ ë¦¬ìŠ¤í¬ ë° ì¤‘ìš”ì‚¬í•­
${(aiAnalysisData.risks || []).map(r => `- ${r}`).join('\n')}

---
## âœ… ì•¡ì…˜ ì•„ì´í…œ
${(aiAnalysisData.action_items || []).map(t => `- [ ] ${t.title} (${t.assignee_name || 'ë¯¸ì§€ì •'}, ~${t.due_date || ''})`).join('\n')}
        `;

        contentArea.value = formattedContent.trim();

        // 2. Extract Selected Tasks
        const selectedTasks = [];
        const checkboxes = document.querySelectorAll('.task-checkbox');
        checkboxes.forEach((chk, idx) => {
            if (chk.checked) {
                selectedTasks.push(aiAnalysisData.action_items[idx]);
            }
        });

        document.getElementById('tasksDataInput').value = JSON.stringify(selectedTasks);

        alert('ë‚´ìš©ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ì‹œ ì„ íƒëœ ì—…ë¬´ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.');
    }

    function prepareSubmit() {
        try {
            // If AI analysis was done, ensure we capture selected tasks even if "Apply" wasn't clicked
            if (typeof aiAnalysisData !== 'undefined' && aiAnalysisData && aiAnalysisData.action_items) {
                const selectedTasks = [];
                const checkboxes = document.querySelectorAll('.task-checkbox');
                checkboxes.forEach((chk, idx) => {
                    if (chk.checked) {
                        selectedTasks.push(aiAnalysisData.action_items[idx]);
                    }
                });

                // Only update if we found selected tasks, otherwise keep existing value (if any)
                if (selectedTasks.length > 0) {
                    document.getElementById('tasksDataInput').value = JSON.stringify(selectedTasks);
                }
            }
        } catch (e) {
            console.error("Error preparing submit:", e);
            // Allow submission to proceed even if task preparation fails
        }
        return true;
    }
</script>
{% endblock %}
```