{% extends "base.html" %}

{% block content %}
<div class="h-full flex flex-col">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">ì—…ë¬´ í…œí”Œë¦¿</h2>
            <p class="text-gray-600 text-sm">í‘œì¤€í™”ëœ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ í…œí”Œë¦¿ ëª©ë¡ì…ë‹ˆë‹¤.</p>
        </div>
        <button onclick="openCreateTemplateModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm text-sm font-medium transition flex items-center">
            <span class="mr-1">âœ¨</span> AI í…œí”Œë¦¿ ìƒì„±
        </button>
    </div>

    <div class="flex-1 overflow-y-auto pr-2 pb-6 space-y-8">

        <!-- Custom Templates Section -->
        {% if custom_templates %}
        <div>
            <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                <span class="w-2 h-6 bg-blue-500 rounded-sm mr-2"></span>
                ì‚¬ìš©ì ì •ì˜ í…œí”Œë¦¿
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for t in custom_templates %}
                <div
                    class="bg-white rounded-xl shadow-sm border border-blue-100 p-6 hover:shadow-md transition-shadow flex flex-col h-full relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">
                        CUSTOM</div>
                    <div class="mb-4">
                        <span
                            class="inline-block px-3 py-1 text-xs font-bold tracking-wide text-blue-600 bg-blue-50 rounded-full mb-2">
                            {{ t.category }}
                        </span>
                        <h3 class="text-lg font-bold text-gray-800 leading-tight cursor-pointer hover:text-blue-600 transition-colors"
                            onclick="openDetailModal('custom_{{ t.id }}')">
                            {{ t.name }}
                        </h3>
                    </div>

                    <p class="text-gray-600 text-sm mb-6 flex-grow">{{ t.description }}</p>

                    <!-- We need to parse JSON here for custom templates -->
                    <!-- Simpler logic: relying on Jinja to allow basic iteration if backend passed objects, but it's a string -->
                    <!-- For simplicity in this iteration, we'll skip detailed phase list for custom unless we deserialize in backend. 
                         However, user wants "same content". Backend passed 'custom_templates' model objects. 'content_json' is text.
                         We'll use a small script to render it or just simple "View Details" logic later. 
                         Wait, I can parse it in the loop if I add a template filter, OR I can just skip the list preview for now. 
                         Let's try to pass parsed data from backend next time. For now, just basic card. -->
                    <button onclick="openDetailModal('custom_{{ t.id }}')"
                        class="mt-auto w-full bg-blue-50 text-blue-600 text-sm font-bold py-2 rounded-lg hover:bg-blue-100 transition">
                        ìƒì„¸ ë³´ê¸°
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Standard Templates Section -->
        <div>
            {% if custom_templates %}
            <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                <span class="w-2 h-6 bg-gray-400 rounded-sm mr-2"></span>
                ê¸°ë³¸ í…œí”Œë¦¿
            </h3>
            {% endif %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for key, t in templates.items() %}
                <div
                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow flex flex-col h-full">
                    <div class="mb-4">
                        <span
                            class="inline-block px-3 py-1 text-xs font-bold tracking-wide text-gray-600 bg-gray-100 rounded-full mb-2">
                            {{ t.category }}
                        </span>
                        <h3 class="text-lg font-bold text-gray-800 leading-tight cursor-pointer hover:text-blue-600 transition-colors"
                            onclick="openDetailModal('{{ key }}')">
                            {{ t.name }}
                        </h3>
                    </div>

                    <p class="text-gray-600 text-sm mb-6 flex-grow">{{ t.description }}</p>

                    <div class="border-t border-gray-100 pt-4 mt-auto">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">í¬í•¨ëœ ë‹¨ê³„ (Phases)</h4>
                        <ul class="space-y-2">
                            {% for phase in t.phases %}
                            <li class="text-sm text-gray-700 flex items-start">
                                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full mr-2 mt-1.5 flex-shrink-0"></span>
                                <span>
                                    <span class="font-medium">{{ phase.phase_name }}</span>
                                    <span class="text-xs text-gray-400 ml-1">({{ phase.tasks|length }}ê°œ ì—…ë¬´)</span>
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div id="createTemplateModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center backdrop-blur-sm"
    style="z-index: 50;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-0 flex flex-col max-h-[90vh]">
        <div
            class="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-500 rounded-t-xl">
            <h3 class="text-xl font-bold text-white flex items-center">
                <span class="mr-2">âœ¨</span> AI í…œí”Œë¦¿ ìƒì„±
            </h3>
            <button onclick="closeCreateTemplateModal()"
                class="text-white/80 hover:text-white text-2xl">&times;</button>
        </div>

        <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
            <!-- Step 1: Input -->
            <div id="step1">
                <label class="block text-gray-700 text-sm font-bold mb-2">
                    ì–´ë–¤ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ë¥¼ ë§Œë“¤ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?
                </label>
                <textarea id="templateTopic"
                    class="w-full h-32 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-base"
                    placeholder="ì˜ˆ: ì‹ ê·œ ëª¨ë°”ì¼ ì•± ëŸ°ì¹­ ë§ˆì¼€íŒ… í”„ë¡œì„¸ìŠ¤, ì‚¬ë‚´ ì›Œí¬ìˆ ì¤€ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸, ì»¤í”¼ í”„ëœì°¨ì´ì¦ˆ ì‹ ê·œ ë§¤ì¥ ì˜¤í”ˆ ì ˆì°¨ ë“±"></textarea>
                <p class="text-xs text-gray-500 mt-2">* êµ¬ì²´ì ìœ¼ë¡œ ì ì„ìˆ˜ë¡ ë” ì •í™•í•œ í…œí”Œë¦¿ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>

                <div class="mt-6 flex justify-end">
                    <button onclick="generateTemplate()"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg transition shadow-lg flex items-center">
                        <span class="text-lg mr-2">ğŸ”®</span> ìƒì„±í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingStep" class="hidden py-10 flex-col items-center justify-center text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-600 font-medium">AIê°€ ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                <p class="text-sm text-gray-400 mt-1">ì•½ 5~10ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.</p>
            </div>

            <!-- Step 2: Preview & Save -->
            <div id="step2" class="hidden">
                <div class="bg-green-50 text-green-700 p-4 rounded-lg mb-6 flex items-start">
                    <span class="text-xl mr-3">âœ…</span>
                    <div>
                        <h4 class="font-bold">í…œí”Œë¦¿ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
                        <p class="text-sm">ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì €ì¥í•˜ì„¸ìš”.</p>
                    </div>
                </div>

                <form action="/work-templates" method="post" id="saveTemplateForm">
                    <input type="hidden" name="content_json" id="resultContentJson">

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">í…œí”Œë¦¿ ì´ë¦„</label>
                            <input type="text" name="name" id="resultName"
                                class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 font-bold text-gray-800">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ì¹´í…Œê³ ë¦¬</label>
                            <input type="text" name="category" id="resultCategory"
                                class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ì„¤ëª…</label>
                        <input type="text" name="description" id="resultDescription"
                            class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-600">
                    </div>

                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 font-bold text-sm text-gray-600">
                            ë¯¸ë¦¬ë³´ê¸°
                        </div>
                        <div class="p-4 max-h-60 overflow-y-auto bg-white text-sm" id="previewArea">
                            <!-- Preview Content -->
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button type="button" onclick="resetModal()"
                            class="flex-1 bg-gray-100 text-gray-600 font-bold py-2 rounded-lg hover:bg-gray-200 transition">
                            ë‹¤ì‹œ ë§Œë“¤ê¸°
                        </button>
                        <button type="submit"
                            class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition shadow-lg">
                            ì €ì¥í•˜ê¸°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function openCreateTemplateModal() {
        const modal = document.getElementById('createTemplateModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        resetModal();
    }

    function closeCreateTemplateModal() {
        const modal = document.getElementById('createTemplateModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function resetModal() {
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('loadingStep').classList.add('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('templateTopic').value = '';
    }

    async function generateTemplate() {
        const topic = document.getElementById('templateTopic').value;
        if (!topic.trim()) {
            alert("ìƒì„±í•  í…œí”Œë¦¿ì˜ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // Show loading
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('loadingStep').classList.remove('hidden');
        document.getElementById('loadingStep').classList.add('flex');

        try {
            const response = await fetch('/api/work-templates/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topic: topic })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.detail || 'ìƒì„± ì‹¤íŒ¨');
            }

            const data = await response.json();

            // Populate form
            document.getElementById('resultName').value = data.name;
            document.getElementById('resultCategory').value = data.category;
            document.getElementById('resultDescription').value = data.description;
            document.getElementById('resultContentJson').value = JSON.stringify(data.phases); // Store just phases array or whole object? Backend expects 'phases' usually. Let's store whole phases array as JSON.

            // Render Preview
            const previewArea = document.getElementById('previewArea');
            let html = '<ul class="space-y-4">';
            if (data.phases && Array.isArray(data.phases)) {
                data.phases.forEach(phase => {
                    html += `
                        <li class="border-b border-gray-100 last:border-0 pb-3 last:pb-0">
                            <h5 class="font-bold text-blue-600 mb-1">${phase.phase_name}</h5>
                            <ul class="pl-4 list-disc text-gray-600 space-y-1">
                                ${phase.tasks.map(t => `<li class="text-xs">
                                    <span class="font-medium text-gray-800">${t.title}</span> 
                                    - ${t.description}
                                </li>`).join('')}
                            </ul>
                        </li>
                    `;
                });
            }
            html += '</ul>';
            previewArea.innerHTML = html;

            // Show Step 2
            document.getElementById('loadingStep').classList.add('hidden');
            document.getElementById('loadingStep').classList.remove('flex');
            document.getElementById('step2').classList.remove('hidden');

        } catch (error) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
            resetModal();
        }
    }
</script>

<!-- Template Detail Modal -->
<div id="detailModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center backdrop-blur-sm"
    style="z-index: 60;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-0 flex flex-col max-h-[85vh]">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
            <div>
                <span id="detailCategory"
                    class="inline-block px-2 py-1 text-[10px] font-bold tracking-wide text-gray-500 bg-white border border-gray-200 rounded-full mb-1">
                    CATEGORY
                </span>
                <h3 id="detailName" class="text-xl font-bold text-gray-800">
                    Template Name
                </h3>
            </div>
            <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
            <p id="detailDescription"
                class="text-gray-600 mb-6 bg-blue-50/50 p-4 rounded-lg border border-blue-50/50 text-sm">
                Description goes here...
            </p>

            <div id="detailContent" class="space-y-6">
                <!-- Phases and Tasks will be rendered here -->
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end rounded-b-xl">
            <button onclick="closeDetailModal()"
                class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-50 transition shadow-sm">
                ë‹«ê¸°
            </button>
        </div>
    </div>
</div>

<script>
    // Construct Grid Data for Static and Custom Templates
    const templateData = {};

    {% for key, t in templates.items() %}
    templateData["{{ key }}"] = {{ t | tojson }};
    {% endfor %}

    {% if custom_templates %}
    {% for t in custom_templates %}
    try {
        templateData["custom_{{ t.id }}"] = {
            "name": {{ t.name | tojson }
    },
    "category": { { t.category | tojson } },
    "description": { { t.description | tojson } },
    "phases": JSON.parse({{ t.content_json | tojson }})
        };
    } catch (e) {
        console.error("Failed to parse custom template {{ t.id }}", e);
    }
    {% endfor %}
    {% endif %}

    function openDetailModal(id) {
        const data = templateData[id];
        if (!data) return;

        document.getElementById('detailCategory').textContent = data.category;
        document.getElementById('detailName').textContent = data.name;
        document.getElementById('detailDescription').textContent = data.description;

        const contentDiv = document.getElementById('detailContent');
        let html = '';

        let phases = data.phases;
        // Normalize phases data
        if (typeof phases === 'string') {
            try {
                phases = JSON.parse(phases);
            } catch (e) {
                console.error("Error parsing phases JSON", e);
                phases = [];
            }
        }
        // Handle { "phases": [...] } wrapper structure
        if (phases && !Array.isArray(phases) && phases.phases && Array.isArray(phases.phases)) {
            phases = phases.phases;
        }

        if (phases && Array.isArray(phases)) {
            phases.forEach((phase, idx) => {
                html += `
                    <div class="mb-6 last:mb-0">
                        <h4 class="font-bold text-gray-800 text-base mb-3 flex items-center">
                            <span class="bg-gray-800 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">${idx + 1}</span>
                            ${phase.phase_name}
                        </h4>
                        <div class="ml-8 space-y-3">
                            ${phase.tasks.map(t => `
                                <div class="bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-300 transition-colors">
                                    <div class="flex justify-between items-start mb-1">
                                        <h5 class="font-bold text-sm text-blue-700">${t.title}</h5>
                                        <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">
                                            ${t.estimated_days}ì¼
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-2">${t.description}</p>
                                    ${t.checklist && t.checklist.length > 0 ? `
                                        <div class="bg-gray-50 rounded p-2">
                                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Checklist</p>
                                            <ul class="space-y-1">
                                                ${t.checklist.map(item => `
                                                    <li class="flex items-center text-xs text-gray-500">
                                                        <span class="w-1 h-1 bg-gray-400 rounded-full mr-2"></span>
                                                        ${item}
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
        }

        contentDiv.innerHTML = html;

        const modal = document.getElementById('detailModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeDetailModal() {
        const modal = document.getElementById('detailModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    {% endblock %}