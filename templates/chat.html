{% extends "base.html" %}

{% block content %}
<div class="flex h-[calc(100vh-80px)] overflow-hidden">
    <!-- Sidebar -->
    <div class="w-1/4 bg-white border-r">
        <div class="p-4 border-b">
            <h2 class="text-xl font-bold">Members</h2>
        </div>
        <div class="overflow-y-auto h-full">
            {% for u in users %}
            <div onclick="selectUser('{{ u.id }}', '{{ u.username }}')"
                class="p-4 border-b cursor-pointer hover:bg-gray-50 flex items-center space-x-3 user-item"
                id="user-item-{{ u.id }}">
                <div
                    class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                    {{ u.username[0] }}
                </div>
                <div>
                    <div class="font-medium">{{ u.username }}</div>
                    <div class="text-xs text-gray-500">{{ u.department or 'N/A' }}</div>
                </div>
                <!-- Unread Badge Placeholder -->
                <div id="badge-{{ u.id }}"
                    class="hidden w-5 h-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center ml-auto">
                    !
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 flex flex-col bg-gray-50">
        <!-- Header -->
        <div class="p-4 bg-white border-b flex items-center justify-between" id="chat-header">
            <h2 class="text-xl font-bold" id="chat-title">Select a member to chat</h2>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages">
            <!-- Messages will appear here -->
            <div class="text-center text-gray-400 mt-10">Select a user from the left to start chatting</div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t hidden" id="chat-input-area">
            <div class="flex space-x-2">
                <input type="text" id="message-input"
                    class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Type a message...">
                <button onclick="sendMessage()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    const currentUserId = "{{ user.id }}";
    let selectedUserId = null;
    let ws = new WebSocket("ws://" + window.location.host + "/ws/" + currentUserId);

    ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        // data = { sender_id, content, timestamp }

        if (selectedUserId && (data.sender_id == selectedUserId || data.sender_id == currentUserId)) {
            appendMessage(data);
            scrollToBottom();
        } else {
            // Show badge if not currently chatting with sender
            if (data.sender_id != currentUserId) {
                const badge = document.getElementById('badge-' + data.sender_id);
                if (badge) badge.classList.remove('hidden');
            }
        }
    };

    function selectUser(userId, username) {
        selectedUserId = userId;
        document.getElementById('chat-title').innerText = "Chat with " + username;
        document.getElementById('chat-input-area').classList.remove('hidden');

        // Clear unread badge
        const badge = document.getElementById('badge-' + userId);
        if (badge) badge.classList.add('hidden');

        // Highlight selected
        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('bg-blue-50'));
        document.getElementById('user-item-' + userId).classList.add('bg-blue-50');

        // Load History
        fetch('/chat/history/' + userId)
            .then(res => res.json())
            .then(messages => {
                const container = document.getElementById('chat-messages');
                container.innerHTML = ''; // Request clear
                messages.forEach(appendMessage);
                scrollToBottom();
            });
    }

    function appendMessage(msg) {
        const container = document.getElementById('chat-messages');
        const isMe = msg.sender_id == currentUserId;

        const div = document.createElement('div');
        div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;

        const inner = document.createElement('div');
        inner.className = `max-w-[70%] rounded-lg px-4 py-2 ${isMe ? 'bg-blue-600 text-white' : 'bg-white border text-gray-800'}`;
        inner.innerText = msg.content;

        // Optional: Timestamp
        // const time = document.createElement('div');
        // time.className = "text-xs mt-1 " + (isMe ? "text-blue-200" : "text-gray-400");
        // time.innerText = new Date(msg.timestamp).toLocaleTimeString();
        // inner.appendChild(time);

        div.appendChild(inner);
        container.appendChild(div);
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text || !selectedUserId) return;

        ws.send(JSON.stringify({
            receiver_id: selectedUserId,
            content: text
        }));

        // Optimistic UI update or wait for echo? 
        // Backend echoes, so we wait for echo to append to ensure consistency.
        // But to make it feel instant, we could append pending.
        // For simple logic, we rely on echo.

        input.value = '';
    }

    function scrollToBottom() {
        const container = document.getElementById('chat-messages');
        container.scrollTop = container.scrollHeight;
    }

    // Allow Enter key
    document.getElementById('message-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
{% endblock %}