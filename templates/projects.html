{% extends "base.html" %}

{% block content %}

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">í”„ë¡œì íŠ¸ (Update v2)</h2>
        <button onclick="document.getElementById('newProjectModal').classList.remove('hidden')"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm text-sm font-medium">
            + ìƒˆ í”„ë¡œì íŠ¸
        </button>
    </div>

    <div class="flex-1 overflow-y-auto pr-2 space-y-8">

        <!-- Scheduled Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-gray-400 mr-2"></span>
                <h3 class="font-bold text-gray-800">ì˜ˆì •</h3>
                <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ scheduled|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>

                            <th scope="col" class="px-6 py-3">ìƒì„±ì</th>
                            <th scope="col" class="px-6 py-3">ê¸°ê°„</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in scheduled %}
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-blue-600 hover:underline cursor-pointer"
                                onclick="projectOpenEditModal(this)" data-id="{{ p.id }}" data-name="{{ p.name|e }}"
                                data-description="{{ (p.description or '')|e }}" data-status="{{ p.status|e }}"
                                data-department="{{ (p.department or '')|e }}"
                                data-assignee-ids='{{ p.assignees|map(attribute="id")|list|tojson|forceescape }}'
                                data-start-date="{{ p.start_date.strftime('%Y-%m') if p.start_date else '' }}"
                                data-end-date="{{ p.end_date.strftime('%Y-%m') if p.end_date else '' }}"
                                data-file-names='{{ p.files|map(attribute="filename")|list|tojson|forceescape }}'
                                data-file-paths='{{ p.files|map(attribute="filepath")|list|tojson|forceescape }}'>
                                {{ p.name }}</td>
                            <td class="px-6 py-4">
                                {% if p.department == 'System' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif p.department == 'Distribution' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>

                            <td class="px-6 py-4">
                                {{ p.start_date.strftime('%Y-%m') if p.start_date else '' }} ~ {{
                                p.end_date.strftime('%Y-%m') if p.end_date else '' }}
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ p.description or '' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- In Progress Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-blue-50 px-6 py-3 border-b border-blue-100 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-blue-500 mr-2"></span>
                <h3 class="font-bold text-blue-800">ì§„í–‰ ì¤‘</h3>
                <span class="ml-2 bg-blue-200 text-blue-800 text-xs px-2 py-0.5 rounded-full">{{ inprogress|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>

                            <th scope="col" class="px-6 py-3">ìƒì„±ì</th>
                            <th scope="col" class="px-6 py-3">ê¸°ê°„</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in inprogress %}
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-blue-600 hover:underline cursor-pointer"
                                onclick="projectOpenEditModal(this)" data-id="{{ p.id }}" data-name="{{ p.name|e }}"
                                data-description="{{ (p.description or '')|e }}" data-status="{{ p.status|e }}"
                                data-department="{{ (p.department or '')|e }}"
                                data-assignee-ids='{{ p.assignees|map(attribute="id")|list|tojson|forceescape }}'
                                data-start-date="{{ p.start_date.strftime('%Y-%m') if p.start_date else '' }}"
                                data-end-date="{{ p.end_date.strftime('%Y-%m') if p.end_date else '' }}"
                                data-file-names='{{ p.files|map(attribute="filename")|list|tojson|forceescape }}'
                                data-file-paths='{{ p.files|map(attribute="filepath")|list|tojson|forceescape }}'>
                                {{ p.name }}</td>
                            <td class="px-6 py-4">
                                {% if p.department == 'System' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif p.department == 'Distribution' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>

                            <td class="px-6 py-4">
                                <span class="text-xs text-gray-500">{{ p.creator.username if p.creator else 'ì‹œìŠ¤í…œ'
                                    }}</span>
                            </td>
                            <td class="px-6 py-4">
                                {{ p.start_date.strftime('%Y-%m') if p.start_date else '' }} ~ {{
                                p.end_date.strftime('%Y-%m') if p.end_date else '' }}
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ p.description or '' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Completed Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-green-50 px-6 py-3 border-b border-green-100 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-green-500 mr-2"></span>
                <h3 class="font-bold text-green-800">ì™„ë£Œ</h3>
                <span class="ml-2 bg-green-200 text-green-800 text-xs px-2 py-0.5 rounded-full">{{ completed|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>

                            <th scope="col" class="px-6 py-3">ìƒì„±ì</th>
                            <th scope="col" class="px-6 py-3">ê¸°ê°„</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in completed %}
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-blue-600 hover:underline cursor-pointer"
                                onclick="projectOpenEditModal(this)" data-id="{{ p.id }}" data-name="{{ p.name|e }}"
                                data-description="{{ (p.description or '')|e }}" data-status="{{ p.status|e }}"
                                data-department="{{ (p.department or '')|e }}"
                                data-assignee-ids='{{ p.assignees|map(attribute="id")|list|tojson|forceescape }}'
                                data-start-date="{{ p.start_date.strftime('%Y-%m') if p.start_date else '' }}"
                                data-end-date="{{ p.end_date.strftime('%Y-%m') if p.end_date else '' }}"
                                data-file-names='{{ p.files|map(attribute="filename")|list|tojson|forceescape }}'
                                data-file-paths='{{ p.files|map(attribute="filepath")|list|tojson|forceescape }}'>
                                {{ p.name }}</td>
                            <td class="px-6 py-4">
                                {% if p.department == 'ì‹œìŠ¤í…œì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif p.department == 'ìœ í†µì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full font-bold">{{
                                    p.department or '-' }}</span>
                                {% endif %}
                            </td>

                            <td class="px-6 py-4">
                                <span class="text-xs text-gray-500">{{ p.creator.username if p.creator else 'ì‹œìŠ¤í…œ'
                                    }}</span>
                            </td>
                            <td class="px-6 py-4">
                                {{ p.start_date.strftime('%Y-%m') if p.start_date else '' }} ~ {{
                                p.end_date.strftime('%Y-%m') if p.end_date else '' }}
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ p.description or '' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">ì™„ë£Œëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Project Modal -->


<script>
    // Explicitly attach to window to avoid scope issues
    window.projectOpenEditModal = function (el) {
        // Debug Alert - Remove after verification
        alert("Script Triggered!");

        try {
            if (!el || !el.dataset) {
                throw new Error("Invalid element or missing dataset");
            }

            const ds = el.dataset;

            // Helper to safely set value
            const setValue = (id, val) => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = val === 'None' || val === null ? '' : val;
                } else {
                    console.warn(`Input with id '${id}' not found`);
                }
            };

            setValue('edit_name', ds.name);
            setValue('edit_description', ds.description);
            setValue('edit_status', ds.status);
            setValue('edit_department', ds.department);
            setValue('edit_start_date', ds.startDate);
            setValue('edit_end_date', ds.endDate);

            // Handle Assignees
            let assignee_ids = [];
            try {
                // If it's a string looking like a list, try to parse it
                assignee_ids = JSON.parse(ds.assigneeIds || '[]');
            } catch (e) {
                console.warn('Error parsing assigneeIds', e);
            }

            const assigneeSelect = document.getElementById('edit_assignee_ids');
            if (assigneeSelect) {
                Array.from(assigneeSelect.options).forEach(o => o.selected = false);
                if (assignee_ids && Array.isArray(assignee_ids)) {
                    Array.from(assigneeSelect.options).forEach(option => {
                        option.selected = assignee_ids.includes(parseInt(option.value));
                    });
                }
            }

            // Handle Files
            let filenames = [];
            let filepaths = [];
            try {
                filenames = JSON.parse(ds.fileNames || '[]');
                filepaths = JSON.parse(ds.filePaths || '[]');
            } catch (e) {
                console.warn('Error parsing file info', e);
            }

            const fileList = document.getElementById('fileList');
            if (fileList) {
                fileList.innerHTML = '';
                if (filenames && filenames.length > 0) {
                    filenames.forEach((name, index) => {
                        const li = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = filepaths[index] || '#';
                        link.textContent = name;
                        link.target = "_blank";
                        link.className = "text-blue-600 hover:underline flex items-center";
                        link.innerHTML = `<span class="mr-2">ğŸ“„</span> ${name}`;
                        li.appendChild(link);
                        fileList.appendChild(li);
                    });
                } else {
                    fileList.innerHTML = '<li class="text-gray-400 italic">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                }
            }

            // Set Form Actions using project ID
            const id = ds.id;
            if (id) {
                const setAction = (formId, url) => {
                    const form = document.getElementById(formId);
                    if (form) form.action = url;
                };
                setAction('editProjectForm', "/projects/" + id + "/update");
                setAction('uploadForm', "/projects/" + id + "/upload");
                setAction('deleteProjectForm', "/projects/" + id + "/delete");
            }

            // Show Modal
            const modal = document.getElementById('editProjectModal');
            if (modal) {
                console.log("Opening modal...", modal);
                // Force visibility using inline styles to override any Tailwind/CSS issues
                modal.classList.remove('hidden'); // Keep this
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.zIndex = '9999';
            } else {
                alert("Error: Modal element not found!");
                throw new Error("Edit Modal element 'editProjectModal' not found in DOM");
            }

        } catch (e) {
            alert('Project Edit Error: ' + e.message);
            console.error(e);
        }
    }

    function deleteProject() {
        if (confirm('ì •ë§ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            document.getElementById('deleteProjectForm').submit();
        }
    }
</script>
{% endblock %}

{% block modals %}

<!-- Project Modal -->
<div id="newProjectModal" style="z-index: 9999;"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ìƒˆ í”„ë¡œì íŠ¸</h3>
            <button onclick="document.getElementById('newProjectModal').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form action="/projects" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸ëª…</label>
                <input type="text" name="name" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ì—…ë¶€</label>
                    <select name="department" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="">ë¯¸ì§€ì •</option>
                        <option value="ì‹œìŠ¤í…œì‚¬ì—…ë¶€">ì‹œìŠ¤í…œì‚¬ì—…ë¶€</option>
                        <option value="ìœ í†µì‚¬ì—…ë¶€">ìœ í†µì‚¬ì—…ë¶€</option>
                        <option value="ê²½ì˜ì§€ì›íŒ€">ê²½ì˜ì§€ì›íŒ€</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì (ë‹¤ì¤‘ ì„ íƒ)</label>
                        <select name="assignee_ids" multiple class="w-full border rounded-lg px-3 py-2 text-sm h-24">
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                        <select name="status" class="w-full border rounded-lg px-3 py-2 text-sm">
                            <option value="Scheduled">ì˜ˆì •</option>
                            <option value="In Progress">ì§„í–‰ ì¤‘</option>
                            <option value="Completed">ì™„ë£Œ</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì›”</label>
                        <input type="month" name="start_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì›”</label>
                        <input type="month" name="end_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ìƒì„±</button>
        </form>
    </div>
</div>

<!-- Edit Project Modal -->
<div id="editProjectModal" style="z-index: 9999;"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">í”„ë¡œì íŠ¸ ìˆ˜ì •</h3>
            <button onclick="document.getElementById('editProjectModal').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form id="editProjectForm" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸ëª…</label>
                <input type="text" name="name" id="edit_name" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" id="edit_description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ì—…ë¶€</label>
                    <select name="department" id="edit_department" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="">ë¯¸ì§€ì •</option>
                        <option value="ì‹œìŠ¤í…œì‚¬ì—…ë¶€">ì‹œìŠ¤í…œì‚¬ì—…ë¶€</option>
                        <option value="ìœ í†µì‚¬ì—…ë¶€">ìœ í†µì‚¬ì—…ë¶€</option>
                        <option value="ê²½ì˜ì§€ì›íŒ€">ê²½ì˜ì§€ì›íŒ€</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì (ë‹¤ì¤‘ ì„ íƒ)</label>
                        <select name="assignee_ids" id="edit_assignee_ids" multiple
                            class="w-full border rounded-lg px-3 py-2 text-sm h-24">
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                        <select name="status" id="edit_status" class="w-full border rounded-lg px-3 py-2 text-sm">
                            <option value="Scheduled">ì˜ˆì •</option>
                            <option value="In Progress">ì§„í–‰ ì¤‘</option>
                            <option value="Completed">ì™„ë£Œ</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì›”</label>
                        <input type="month" name="start_date" id="edit_start_date"
                            class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì›”</label>
                        <input type="month" name="end_date" id="edit_end_date"
                            class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>

                <!-- File Management Section -->
                <div class="border-t pt-2 mt-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì²¨ë¶€ íŒŒì¼</label>

                    <!-- Existing Files List -->
                    <div id="existingFilesList" class="space-y-1 mb-3 text-sm text-gray-600">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Upload Form (visually integrated) -->
                    <div class="flex items-center gap-2">
                        <input type="file" name="files" multiple
                            class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="submit" formaction="" id="updateBtn"
                        class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ìˆ˜ì •</button>
                    <!-- Link separate delete logic manually or via js logic -->
                    <button type="button"
                        onclick="if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { document.getElementById('deleteForm').submit(); }"
                        class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition">ì‚­ì œ</button>
                </div>
        </form>
        <!-- Hidden Delete Form (Helper) -->
        <form id="deleteForm" method="post" action="">
            <input type="hidden" name="_method" value="DELETE">
            <!-- Assuming backend supports this or just post to delete endpoint -->
        </form>
    </div>
</div>
{% endblock %}