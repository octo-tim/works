{% extends "base.html" %}

{% block content %}

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">í”„ë¡œì íŠ¸ê´€ë¦¬</h2>
        <button onclick="document.getElementById('newProjectModal').classList.remove('hidden')"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm text-sm font-medium">
            + ìƒˆ í”„ë¡œì íŠ¸
        </button>
    </div>

    <div class="flex-1 overflow-y-auto pr-2 space-y-8">

        <!-- Scheduled Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-gray-400 mr-2"></span>
                <h3 class="font-bold text-gray-800">ì˜ˆì •</h3>
                <span class="ml-2 bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ scheduled|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>
                            <th scope="col" class="px-6 py-3">ìƒì„±ì</th>
                            <th scope="col" class="px-6 py-3">ê¸°ê°„</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                            <th scope="col" class="px-6 py-3">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in scheduled %}
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-blue-600">
                                <a href="javascript:void(0)" class="project-task-link hover:underline"
                                    data-project-id="{{ p.id }}" data-project-name="{{ p.name }}">{{ p.name }}</a>
                            </td>
                            <td class="px-6 py-4">
                                {% if p.department == 'System' or p.department == 'ì‹œìŠ¤í…œì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif p.department == 'Distribution' or p.department == 'ìœ í†µì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs text-gray-500">{{ p.creator.username if p.creator else 'ì‹œìŠ¤í…œ'
                                    }}</span>
                            </td>
                            <td class="px-6 py-4">
                                {{ p.start_date.strftime('%Y-%m') if p.start_date else '' }} ~ {{
                                p.end_date.strftime('%Y-%m') if p.end_date else '' }}
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ p.description or '' }}</td>
                            <td class="px-6 py-4">
                                <button onclick="projectOpenEditModal(this)" data-id="{{ p.id }}"
                                    data-name="{{ p.name|e }}" data-description="{{ (p.description or '')|e }}"
                                    data-status="{{ p.status|e }}" data-department="{{ (p.department or '')|e }}"
                                    data-assignee-ids='{{ p.assignees|map(attribute="id")|list|tojson|forceescape }}'
                                    data-start-date="{{ p.start_date.strftime('%Y-%m') if p.start_date else '' }}"
                                    data-end-date="{{ p.end_date.strftime('%Y-%m') if p.end_date else '' }}"
                                    data-file-names='{{ p.files|map(attribute="filename")|list|tojson|forceescape }}'
                                    data-file-paths='{{ p.files|map(attribute="filepath")|list|tojson|forceescape }}'
                                    class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-gray-100 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-400">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- In Progress Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-blue-50 px-6 py-3 border-b border-blue-100 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-blue-500 mr-2"></span>
                <h3 class="font-bold text-blue-800">ì§„í–‰ ì¤‘</h3>
                <span class="ml-2 bg-blue-200 text-blue-800 text-xs px-2 py-0.5 rounded-full">{{ inprogress|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>
                            <th scope="col" class="px-6 py-3">ìƒì„±ì</th>
                            <th scope="col" class="px-6 py-3">ê¸°ê°„</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                            <th scope="col" class="px-6 py-3">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in inprogress %}
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-blue-600">
                                <a href="javascript:void(0)" class="project-task-link hover:underline"
                                    data-project-id="{{ p.id }}" data-project-name="{{ p.name }}">{{ p.name }}</a>
                            </td>
                            <td class="px-6 py-4">
                                {% if p.department == 'System' or p.department == 'ì‹œìŠ¤í…œì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif p.department == 'Distribution' or p.department == 'ìœ í†µì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs text-gray-500">{{ p.creator.username if p.creator else 'ì‹œìŠ¤í…œ'
                                    }}</span>
                            </td>
                            <td class="px-6 py-4">
                                {{ p.start_date.strftime('%Y-%m') if p.start_date else '' }} ~ {{
                                p.end_date.strftime('%Y-%m') if p.end_date else '' }}
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ p.description or '' }}</td>
                            <td class="px-6 py-4">
                                <button onclick="projectOpenEditModal(this)" data-id="{{ p.id }}"
                                    data-name="{{ p.name|e }}" data-description="{{ (p.description or '')|e }}"
                                    data-status="{{ p.status|e }}" data-department="{{ (p.department or '')|e }}"
                                    data-assignee-ids='{{ p.assignees|map(attribute="id")|list|tojson|forceescape }}'
                                    data-start-date="{{ p.start_date.strftime('%Y-%m') if p.start_date else '' }}"
                                    data-end-date="{{ p.end_date.strftime('%Y-%m') if p.end_date else '' }}"
                                    data-file-names='{{ p.files|map(attribute="filename")|list|tojson|forceescape }}'
                                    data-file-paths='{{ p.files|map(attribute="filepath")|list|tojson|forceescape }}'
                                    class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-gray-100 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-400">ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Completed Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-green-50 px-6 py-3 border-b border-green-100 flex items-center">
                <span class="w-2.5 h-2.5 rounded-full bg-green-500 mr-2"></span>
                <h3 class="font-bold text-green-800">ì™„ë£Œ</h3>
                <span class="ml-2 bg-green-200 text-green-800 text-xs px-2 py-0.5 rounded-full">{{ completed|length
                    }}</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                        <tr>
                            <th scope="col" class="px-6 py-3">í”„ë¡œì íŠ¸ëª…</th>
                            <th scope="col" class="px-6 py-3">ì‚¬ì—…ë¶€</th>
                            <th scope="col" class="px-6 py-3">ìƒì„±ì</th>
                            <th scope="col" class="px-6 py-3">ê¸°ê°„</th>
                            <th scope="col" class="px-6 py-3">ì„¤ëª…</th>
                            <th scope="col" class="px-6 py-3">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in completed %}
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-blue-600">
                                <a href="javascript:void(0)" class="project-task-link hover:underline"
                                    data-project-id="{{ p.id }}" data-project-name="{{ p.name }}">{{ p.name }}</a>
                            </td>
                            <td class="px-6 py-4">
                                {% if p.department == 'System' or p.department == 'ì‹œìŠ¤í…œì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">ì‹œìŠ¤í…œ</span>
                                {% elif p.department == 'Distribution' or p.department == 'ìœ í†µì‚¬ì—…ë¶€' %}
                                <span
                                    class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full font-bold">ìœ í†µ</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                                <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full font-bold">{{
                                    p.department or '-' }}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs text-gray-500">{{ p.creator.username if p.creator else 'ì‹œìŠ¤í…œ'
                                    }}</span>
                            </td>
                            <td class="px-6 py-4">
                                {{ p.start_date.strftime('%Y-%m') if p.start_date else '' }} ~ {{
                                p.end_date.strftime('%Y-%m') if p.end_date else '' }}
                            </td>
                            <td class="px-6 py-4 truncate max-w-xs">{{ p.description or '' }}</td>
                            <td class="px-6 py-4">
                                <button onclick="projectOpenEditModal(this)" data-id="{{ p.id }}"
                                    data-name="{{ p.name|e }}" data-description="{{ (p.description or '')|e }}"
                                    data-status="{{ p.status|e }}" data-department="{{ (p.department or '')|e }}"
                                    data-assignee-ids='{{ p.assignees|map(attribute="id")|list|tojson|forceescape }}'
                                    data-start-date="{{ p.start_date.strftime('%Y-%m') if p.start_date else '' }}"
                                    data-end-date="{{ p.end_date.strftime('%Y-%m') if p.end_date else '' }}"
                                    data-file-names='{{ p.files|map(attribute="filename")|list|tojson|forceescape }}'
                                    data-file-paths='{{ p.files|map(attribute="filepath")|list|tojson|forceescape }}'
                                    class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-gray-100 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                    </svg>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-400">ì™„ë£Œëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Project Modal -->


<script>
    // Check for URL parameters for error handling
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        if (error === 'duplicate_name') {
            alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”„ë¡œì íŠ¸ëª…ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            // Clean URL
            const url = new URL(window.location.href);
            url.searchParams.delete('error');
            window.history.replaceState({}, document.title, url);
        } else if (error) {
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
        }
    });

    // Explicitly attach to window to avoid scope issues
    window.projectOpenEditModal = function (el) {
        console.log("projectOpenEditModal called with element:", el);

        try {
            if (!el) {
                console.error("Element is null or undefined");
                alert("ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (!el.dataset) {
                console.error("Element dataset is missing");
                alert("ë°ì´í„° ì†ì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            console.log("Element dataset:", el.dataset);

            const ds = el.dataset;

            // Helper to safely set value
            const setValue = (id, val) => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = val === 'None' || val === null ? '' : val;
                } else {
                    console.warn(`Input with id '${id}' not found`);
                }
            };

            setValue('edit_name', ds.name || '');
            setValue('edit_description', ds.description || '');
            setValue('edit_status', ds.status || 'Scheduled');
            setValue('edit_department', ds.department || '');
            // data-start-dateëŠ” startDateë¡œ, data-end-dateëŠ” endDateë¡œ ì ‘ê·¼
            // í˜¹ì‹œ ëª¨ë¥¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ getAttributeë¡œë„ ì‹œë„
            const startDate = ds.startDate || el.getAttribute('data-start-date') || '';
            const endDate = ds.endDate || el.getAttribute('data-end-date') || '';
            setValue('edit_start_date', startDate);
            setValue('edit_end_date', endDate);

            // Handle Assignees
            let assignee_ids = [];
            try {
                // If it's a string looking like a list, try to parse it
                assignee_ids = JSON.parse(ds.assigneeIds || '[]');
            } catch (e) {
                console.warn('Error parsing assigneeIds', e);
            }

            const assigneeSelect = document.getElementById('edit_assignee_ids');
            if (assigneeSelect) {
                Array.from(assigneeSelect.options).forEach(o => o.selected = false);
                if (assignee_ids && Array.isArray(assignee_ids)) {
                    Array.from(assigneeSelect.options).forEach(option => {
                        option.selected = assignee_ids.includes(parseInt(option.value));
                    });
                }
            }

            // Handle Files
            let filenames = [];
            let filepaths = [];
            try {
                filenames = JSON.parse(ds.fileNames || '[]');
                filepaths = JSON.parse(ds.filePaths || '[]');
            } catch (e) {
                console.warn('Error parsing file info', e);
            }

            const fileList = document.getElementById('existingFilesList');
            if (fileList) {
                fileList.innerHTML = '';
                if (filenames && filenames.length > 0) {
                    filenames.forEach((name, index) => {
                        const div = document.createElement('div');
                        const link = document.createElement('a');
                        link.href = filepaths[index] || '#';
                        link.textContent = name;
                        link.target = "_blank";
                        link.className = "text-blue-600 hover:underline flex items-center";
                        link.innerHTML = `<span class="mr-2">ğŸ“„</span> ${name}`;
                        div.appendChild(link);
                        fileList.appendChild(div);
                    });
                } else {
                    fileList.innerHTML = '<div class="text-gray-400 italic text-sm">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            }

            // Set Form Actions using project ID
            const id = ds.id;
            if (id) {
                const setAction = (formId, url) => {
                    const form = document.getElementById(formId);
                    if (form) {
                        form.action = url;
                        console.log(`Set ${formId} action to: ${url}`);
                    } else {
                        // uploadFormì€ ì„ íƒì ì´ë¯€ë¡œ ê²½ê³ ë¥¼ infoë¡œ ë³€ê²½
                        if (formId !== 'uploadForm') {
                            console.warn(`Form ${formId} not found`);
                        }
                    }
                };
                setAction('editProjectForm', "/projects/" + id + "/update");
                setAction('uploadForm', "/projects/" + id + "/upload"); // ì„ íƒì 
                setAction('deleteProjectForm', "/projects/" + id + "/delete");

                // Verify form action was set and attach submit handler
                const editForm = document.getElementById('editProjectForm');
                if (editForm) {
                    console.log("Edit form action after setting:", editForm.action);
                    // Remove any existing event listeners
                    editForm.onsubmit = null;
                    // Add new event listener
                    editForm.addEventListener('submit', function (event) {
                        const form = this;
                        const deptSelect = document.getElementById('edit_department');
                        console.log('=== FORM SUBMIT EVENT TRIGGERED (initial) ===');
                        console.log('Form submitting - Action:', form.action);
                        console.log('Department select element:', deptSelect);
                        console.log('Department value:', deptSelect?.value);

                        // Get all form data
                        const formData = new FormData(form);
                        console.log('FormData entries:');
                        for (let [key, value] of formData.entries()) {
                            console.log(`  ${key}: ${value}`);
                        }

                        if (!form.action) {
                            event.preventDefault();
                            alert('í”„ë¡œì íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            return false;
                        }

                        // Verify department is included
                        if (!formData.has('department')) {
                            console.warn('WARNING: department field not found in form data!');
                        }

                        console.log('Form will submit to:', form.action);
                        return true;
                    }, false);

                    // Save button handler will be set up after modal is shown
                }
            }

            // Show Modal
            console.log("Attempting to show modal...");
            let modal = document.getElementById('editProjectModal');
            if (!modal) {
                console.error("Modal element 'editProjectModal' not found in DOM");
                alert("ìˆ˜ì • íŒì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                return;
            }

            console.log("Modal found:", modal);
            console.log("Modal parent:", modal.parentElement);
            console.log("Modal current classes:", modal.className);
            console.log("Modal current style.display:", modal.style.display);

            // Move modal to body if it's not already there (ensures highest z-index context)
            if (modal.parentElement !== document.body) {
                console.log("Moving modal to body for better z-index stacking");
                const modalClone = modal.cloneNode(true);
                modal.remove();
                document.body.appendChild(modalClone);
                modal = document.getElementById('editProjectModal');
                console.log("Modal moved to body, new parent:", modal.parentElement);

                // Re-set form actions after moving modal (forms are now new elements)
                const id = ds.id;
                if (id) {
                    const setAction = (formId, url) => {
                        const form = document.getElementById(formId);
                        if (form) {
                            form.action = url;
                            console.log(`Re-set ${formId} action to: ${url} after modal move`);
                        } else {
                            // uploadFormì€ ì„ íƒì ì´ë¯€ë¡œ ê²½ê³ ë¥¼ ì¶œë ¥í•˜ì§€ ì•ŠìŒ
                            if (formId !== 'uploadForm') {
                                console.warn(`Form ${formId} not found after modal move`);
                            }
                        }
                    };
                    setAction('editProjectForm', "/projects/" + id + "/update");
                    setAction('uploadForm', "/projects/" + id + "/upload"); // ì„ íƒì 
                    setAction('deleteProjectForm', "/projects/" + id + "/delete");

                    // Re-attach onsubmit event handler after modal move
                    const editForm = document.getElementById('editProjectForm');
                    if (editForm) {
                        // Remove any existing event listeners by cloning and replacing
                        const newForm = editForm.cloneNode(true);
                        editForm.parentNode.replaceChild(newForm, editForm);
                        const freshForm = document.getElementById('editProjectForm');

                        // Re-set action after cloning
                        freshForm.action = "/projects/" + id + "/update";

                        // Re-set onsubmit attribute after cloning
                        freshForm.onsubmit = function (event) {
                            event.preventDefault();
                            const form = this;
                            const deptSelect = document.getElementById('edit_department');
                            if (!form || !form.action) {
                                alert('í”„ë¡œì íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                return false;
                            }
                            console.log('=== FORM SUBMIT (after modal move) ===');
                            console.log('Form action:', form.action);
                            console.log('Department value:', deptSelect?.value);
                            const formData = new FormData(form);
                            console.log('FormData entries:');
                            for (let [key, value] of formData.entries()) {
                                console.log(`  ${key}: ${value}`);
                            }
                            if (!formData.has('department')) {
                                console.warn('WARNING: department field not found in form data!');
                            }
                            form.submit();
                            return false;
                        };

                        // Add event listener to fresh form (backup)
                        freshForm.addEventListener('submit', function (event) {
                            const form = this;
                            const deptSelect = document.getElementById('edit_department');
                            console.log('=== FORM SUBMIT EVENT TRIGGERED (after modal move) ===');
                            console.log('Form submitting - Action:', form.action);
                            console.log('Department select element:', deptSelect);
                            console.log('Department value:', deptSelect?.value);

                            // Get all form data
                            const formData = new FormData(form);
                            console.log('FormData entries:');
                            for (let [key, value] of formData.entries()) {
                                console.log(`  ${key}: ${value}`);
                            }

                            if (!form.action) {
                                event.preventDefault();
                                alert('í”„ë¡œì íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                return false;
                            }

                            // Verify department is included
                            if (!formData.has('department')) {
                                console.warn('WARNING: department field not found in form data!');
                            }

                            console.log('Form will submit to:', form.action);
                            return true;
                        }, false);
                        console.log('Re-attached onsubmit handler to editProjectForm after modal move and form clone');

                        // Save button handler will be set up after modal is shown
                    } else {
                        console.error('editProjectForm not found after modal move!');
                    }
                }
            }

            // Set up save button click handler - do this after modal is fully displayed
            // Use multiple attempts to ensure button is found
            function setupSaveButtonHandler() {
                const saveBtn = document.getElementById('updateBtn');
                if (saveBtn) {
                    // Remove all existing handlers
                    saveBtn.onclick = null;
                    if (window.handleSaveButtonClickDirect) {
                        saveBtn.removeEventListener('click', window.handleSaveButtonClickDirect, true);
                    }

                    // Create handler function
                    window.handleSaveButtonClickDirect = function (event) {
                        console.log('=== SAVE BUTTON CLICKED ===');
                        event.preventDefault();
                        event.stopPropagation();

                        const form = document.getElementById('editProjectForm');
                        const deptSelect = document.getElementById('edit_department');

                        if (!form || !form.action) {
                            alert('í”„ë¡œì íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            return false;
                        }

                        if (!deptSelect) {
                            console.error('ERROR: edit_department element not found!');
                            alert('ì‚¬ì—…ë¶€ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            return false;
                        }

                        console.log('Form action:', form.action);
                        console.log('Department value:', deptSelect.value);

                        const formData = new FormData(form);

                        // Always ensure department is set correctly
                        formData.set('department', deptSelect.value);

                        console.log('FormData entries:');
                        for (let [key, value] of formData.entries()) {
                            console.log(`  ${key}: ${value}`);
                        }

                        // Submit using fetch
                        console.log('Submitting form via fetch to:', form.action);
                        fetch(form.action, {
                            method: form.method,
                            body: formData
                        })
                            .then(response => {
                                console.log('Response status:', response.status);
                                if (response.redirected) {
                                    console.log('Redirected to:', response.url);
                                    window.location.href = response.url;
                                } else if (response.ok) {
                                    window.location.reload();
                                } else {
                                    return response.text().then(text => {
                                        console.error('Error response:', text);
                                        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error submitting form:', error);
                                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                            });

                        return false;
                    };

                    // Attach handler with capture phase
                    saveBtn.addEventListener('click', window.handleSaveButtonClickDirect, true);
                    console.log('âœ“ Save button click handler attached');
                    return true;
                } else {
                    console.warn('âœ— Save button (updateBtn) not found, will retry...');
                    return false;
                }
            }

            // Try immediately
            if (!setupSaveButtonHandler()) {
                // Try after a short delay
                setTimeout(function () {
                    if (!setupSaveButtonHandler()) {
                        // Try after another delay
                        setTimeout(setupSaveButtonHandler, 200);
                    }
                }, 50);
            }

            // Remove hidden class and any conflicting classes
            modal.classList.remove('hidden');
            // Add flex class explicitly
            modal.classList.add('flex');
            console.log("Removed 'hidden' class, added 'flex' class");
            console.log("Modal classes after update:", modal.className);

            // Force display with inline style (overrides Tailwind hidden class)
            // Use setProperty with important flag for maximum compatibility
            // Set extremely high z-index to ensure it's on top of everything
            modal.style.setProperty('display', 'flex', 'important');
            modal.style.setProperty('visibility', 'visible', 'important');
            modal.style.setProperty('opacity', '1', 'important');
            modal.style.setProperty('z-index', '2147483647', 'important'); // Maximum z-index value
            modal.style.setProperty('background-color', 'rgba(0, 0, 0, 0.5)', 'important');
            modal.style.setProperty('position', 'fixed', 'important');
            modal.style.setProperty('top', '0', 'important');
            modal.style.setProperty('left', '0', 'important');
            modal.style.setProperty('width', '100vw', 'important');
            modal.style.setProperty('height', '100vh', 'important');
            modal.style.setProperty('align-items', 'center', 'important');
            modal.style.setProperty('justify-content', 'center', 'important');
            modal.style.setProperty('pointer-events', 'auto', 'important');
            modal.style.setProperty('margin', '0', 'important');
            modal.style.setProperty('padding', '0', 'important');

            // Ensure inner content is visible
            const modalContent = modal.querySelector('div.bg-white');
            if (modalContent) {
                modalContent.style.setProperty('position', 'relative', 'important');
                modalContent.style.setProperty('z-index', '2147483647', 'important');
                modalContent.style.setProperty('background-color', 'white', 'important');
                modalContent.style.setProperty('opacity', '1', 'important');
                modalContent.style.setProperty('visibility', 'visible', 'important');
                modalContent.style.setProperty('display', 'block', 'important');
                console.log("Modal content styled:", modalContent);
                console.log("Modal content computed z-index:", window.getComputedStyle(modalContent).zIndex);
            }

            // Force body scroll lock
            document.body.style.overflow = 'hidden';

            // Check all parent elements for z-index or overflow issues
            let parent = modal.parentElement;
            let depth = 0;
            while (parent && parent !== document.body && depth < 10) {
                const parentStyle = window.getComputedStyle(parent);
                console.log(`Parent ${depth} (${parent.tagName}): z-index=${parentStyle.zIndex}, overflow=${parentStyle.overflow}, position=${parentStyle.position}`);
                if (parseInt(parentStyle.zIndex) > 0 && parseInt(parentStyle.zIndex) >= parseInt(window.getComputedStyle(modal).zIndex)) {
                    console.warn(`Parent has higher z-index: ${parentStyle.zIndex}`);
                }
                parent = parent.parentElement;
                depth++;
            }

            console.log("Modal should now be visible");
            const computedStyle = window.getComputedStyle(modal);
            console.log("Modal final computed style.display:", computedStyle.display);
            console.log("Modal final computed z-index:", computedStyle.zIndex);
            console.log("Modal final classes:", modal.className);

            // Double check after a short delay
            setTimeout(() => {
                const finalComputedStyle = window.getComputedStyle(modal);
                console.log("After timeout - computed display:", finalComputedStyle.display);
                console.log("After timeout - computed z-index:", finalComputedStyle.zIndex);
                console.log("After timeout - computed visibility:", finalComputedStyle.visibility);
                console.log("After timeout - computed opacity:", finalComputedStyle.opacity);
                if (finalComputedStyle.display === 'none' || finalComputedStyle.visibility === 'hidden') {
                    console.error("Modal is still hidden! Forcing display again...");
                    modal.style.setProperty('display', 'flex', 'important');
                    modal.style.setProperty('visibility', 'visible', 'important');
                }

                // Check if modal is actually visible on screen
                const rect = modal.getBoundingClientRect();
                console.log("Modal bounding rect:", rect);
                if (rect.width === 0 || rect.height === 0) {
                    console.error("Modal has zero dimensions!");
                }
            }, 100);

        } catch (e) {
            alert('Project Edit Error: ' + e.message);
            console.error(e);
        }
    }

    function deleteProject() {
        if (confirm('ì •ë§ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            document.getElementById('deleteProjectForm').submit();
        }
    }

    function closeEditProjectModal() {
        const modal = document.getElementById('editProjectModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }

    // Ensure function is available globally and verify setup
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM loaded, verifying project edit modal setup");

        // Verify function exists
        if (typeof window.projectOpenEditModal === 'function') {
            console.log("âœ“ projectOpenEditModal function is available");
        } else {
            console.error("âœ— projectOpenEditModal function is NOT available!");
        }

        // Verify modal exists
        const modal = document.getElementById('editProjectModal');
        if (modal) {
            console.log("âœ“ Edit modal found in DOM");
        } else {
            console.error("âœ— Edit modal NOT found in DOM!");
            alert("ìˆ˜ì • íŒì—… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
        }

        // Add click event listeners as backup (in addition to onclick)
        const projectNameCells = document.querySelectorAll('td[onclick*="projectOpenEditModal"]');
        console.log("Found project name cells with onclick:", projectNameCells.length);

        projectNameCells.forEach(function (cell) {
            // Add event listener as backup (onclick will also work)
            cell.addEventListener('click', function (e) {
                console.log("Project name cell clicked (event listener)");
                // Don't prevent default - let onclick handle it first
                // This is just for debugging
            }, true); // Use capture phase for debugging
        });
    });

    // Delegated event listener for project task links
    document.addEventListener('click', function (e) {
        const link = e.target.closest('.project-task-link');
        if (link) {
            e.preventDefault();
            const pid = link.getAttribute('data-project-id');
            const pname = link.getAttribute('data-project-name');
            console.log("Project link clicked via delegation:", pid, pname);
            openProjectTasksModal(pid, pname);
        }
    });

    // Attach to window to ensure global availability
    window.openProjectTasksModal = function (projectId, projectName) {
        if (!projectId) {
            console.error("No project ID provided to openProjectTasksModal");
            return;
        }
        console.log("Opening tasks for project:", projectId, projectName);

        // Find modal
        let modal = document.getElementById('projectTasksModal');

        if (!modal) {
            console.error("Project tasks modal not found!");
            alert("ì—…ë¬´ ëª©ë¡ íŒì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // Move modal to body if needed (Fixes z-index/stacking contexts)
        if (modal.parentElement !== document.body) {
            console.log("Moving projectTasksModal to body for better stacking");
            const modalClone = modal.cloneNode(true);
            modal.remove();
            document.body.appendChild(modalClone);
            modal = document.getElementById('projectTasksModal');
        }

        const titleEl = document.getElementById('projectTasksModalTitle');
        const listEl = document.getElementById('projectTasksList');
        const loadingEl = document.getElementById('projectTasksLoading');
        const emptyEl = document.getElementById('projectTasksEmpty');
        const linkEl = document.getElementById('projectTasksDashboardLink');

        // Setup modal content
        if (titleEl) titleEl.textContent = projectName + " - ì—…ë¬´ ëª©ë¡";
        if (linkEl) linkEl.href = "/?project_id=" + projectId;
        if (listEl) listEl.innerHTML = '';

        // Show modal and loading
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Force robust display styles
        modal.style.setProperty('display', 'flex', 'important');
        modal.style.setProperty('z-index', '2147483647', 'important'); // Max int value
        modal.style.setProperty('visibility', 'visible', 'important');
        modal.style.setProperty('opacity', '1', 'important');
        modal.style.setProperty('position', 'fixed', 'important');
        modal.style.setProperty('top', '0', 'important');
        modal.style.setProperty('left', '0', 'important');

        if (loadingEl) loadingEl.classList.remove('hidden');
        if (emptyEl) emptyEl.classList.add('hidden');

        // Fetch tasks
        fetch('/api/projects/' + projectId + '/tasks')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                loadingEl.classList.add('hidden');

                if (data.length === 0) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                data.forEach(task => {
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-gray-50";

                    // Status Badge coloring
                    let statusClass = "bg-gray-100 text-gray-800";
                    let statusText = "ì˜ˆì •";
                    if (task.status === "In Progress") {
                        statusClass = "bg-blue-100 text-blue-800";
                        statusText = "ì§„í–‰ ì¤‘";
                    } else if (task.status === "Done") {
                        statusClass = "bg-green-100 text-green-800";
                        statusText = "ì™„ë£Œ";
                    }

                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <span class="${statusClass} text-xs font-medium px-2.5 py-0.5 rounded">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900">${task.title}</td>
                        <td class="px-6 py-4">${task.assignees_str || '-'}</td>
                        <td class="px-6 py-4">${task.due_date || '-'}</td>
                    `;
                    listEl.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Error fetching tasks:', error);
                loadingEl.classList.add('hidden');
                listEl.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            });
    }; // Corrected: Removed duplicate '});' and '}'

    // Function to close the project tasks modal
    function closeProjectTasksModal() {
        const modal = document.getElementById('projectTasksModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            // Clear robust inline styles
            modal.style.display = 'none';
            modal.style.zIndex = '';
            modal.style.visibility = '';
            modal.style.opacity = '';
            document.body.style.overflow = ''; // Restore scrolling
        }
    }

    // AI WBS Generation Logic
    function generateWBS() {
        const goal = document.getElementById('ai_goal').value;
        const pType = document.getElementById('ai_type').value;
        const scope = document.getElementById('ai_scope').value;
        const stakeholderCbs = document.querySelectorAll('.ai-stakeholder:checked');
        const stakeholders = Array.from(stakeholderCbs).map(cb => cb.value).join(', ');

        const modal = document.getElementById('newProjectModal');
        let deadline = modal.querySelector('input[name="end_date"]').value;

        if (!goal) {
            alert("í”„ë¡œì íŠ¸ ëª©í‘œ/ì‚°ì¶œë¬¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const btn = document.getElementById('btnGenerateWBS');
        const originalText = btn.textContent;
        btn.textContent = "ìƒì„± ì¤‘...";
        btn.disabled = true;

        fetch('/api/projects/ai-wbs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                goal: goal,
                deadline: deadline,
                type: pType,
                scope: scope,
                stakeholders: stakeholders
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.detail) throw new Error(data.detail);

                // Phase based check
                if (data.phases) {
                    displayWBSPhases(data.phases);
                } else if (data.tasks) {
                    displayWBSTasks(data.tasks); // Fallback
                } else {
                    throw new Error("No phases/tasks returned");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì—…ë¬´ ì œì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            })
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
    }

    let globalAIPhases = []; // Store full hierarchical data for phases
    let currentSuggestedTasks = []; // Legacy flat list

    // New Hierarchical Display
    function displayWBSPhases(phases) {
        globalAIPhases = phases;
        const listEl = document.getElementById('ai_task_list');
        listEl.innerHTML = '';

        phases.forEach((phase, pIndex) => {
            // Phase Header
            const phaseDiv = document.createElement('div');
            phaseDiv.className = "mb-4 last:mb-0";
            phaseDiv.innerHTML = `
                <div class="flex items-center gap-2 mb-2 sticky top-0 bg-white z-10 py-1">
                    <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-0.5 rounded-full ring-1 ring-indigo-200">
                        ${phase.phase_name}
                    </span>
                    <div class="h-px bg-gray-200 flex-1"></div>
                </div>
                <div class="space-y-2 pl-1" id="phase_tasks_${pIndex}">
                    <!-- Tasks go here -->
                </div>
            `;

            const tasksContainer = phaseDiv.querySelector(`#phase_tasks_${pIndex}`);

            phase.tasks.forEach((task, tIndex) => {
                const isCore = task.is_core !== false;
                const taskDiv = document.createElement('div');
                taskDiv.className = "flex items-start gap-3 p-2.5 bg-gray-50 hover:bg-white rounded-lg border border-gray-200 shadow-sm transition-all group";

                // Checklist HTML
                let checklistHtml = '';
                if (task.checklist && task.checklist.length > 0) {
                    checklistHtml = `<ul class="text-[11px] text-gray-500 mt-1.5 space-y-0.5 list-disc pl-3 opacity-90">
                        ${task.checklist.map(item => `<li>${item}</li>`).join('')}
                     </ul>`;
                }

                taskDiv.innerHTML = `
                    <div class="pt-0.5">
                         <input type="checkbox" id="ai_task_${pIndex}_${tIndex}" 
                            class="ai-task-cb w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500" 
                            data-phase="${phase.phase_name}" 
                            data-pindex="${pIndex}" 
                            data-tindex="${tIndex}"
                            ${isCore ? 'checked' : ''} 
                            data-is-core="${isCore}"
                            onchange="updateSuggestedTasksInput()">
                    </div>
                    <label for="ai_task_${pIndex}_${tIndex}" class="cursor-pointer flex-1 user-select-none">
                        <div class="flex justify-between items-start">
                            <span class="font-bold text-gray-800 text-sm group-hover:text-indigo-700 transition-colors">${task.title}</span>
                            <span class="text-[10px] bg-white border border-gray-200 text-gray-400 px-1.5 rounded">${task.estimated_days}ì¼</span>
                        </div>
                         ${checklistHtml}
                    </label>
                `;
                tasksContainer.appendChild(taskDiv);
            });

            listEl.appendChild(phaseDiv);
        });

        document.getElementById('ai_result_area').classList.remove('hidden');
        updateSuggestedTasksInput();
    }

    // Helper: Select All
    function selectAllAI(checked) {
        const cbs = document.querySelectorAll('.ai-task-cb');
        cbs.forEach(cb => cb.checked = checked);
        updateSuggestedTasksInput();
    }

    // Helper: Select Core Only
    function selectCoreAI() {
        const cbs = document.querySelectorAll('.ai-task-cb');
        cbs.forEach(cb => {
            // Only check if it's core, otherwise uncheck
            const isCore = cb.getAttribute('data-is-core') === 'true';
            cb.checked = isCore; // If core=true, checked. If core=false, unchecked.
        });
        updateSuggestedTasksInput();
    }

    function updateSuggestedTasksInput() {
        const checkBoxes = document.querySelectorAll('.ai-task-cb');
        const selectedTasks = [];

        checkBoxes.forEach((cb) => {
            if (cb.checked) {
                // Determine if it came from phase or flat list
                const pIndex = cb.getAttribute('data-pindex');
                const tIndex = cb.getAttribute('data-tindex');

                if (pIndex !== null && tIndex !== null && globalAIPhases.length > 0) {
                    // Hierarchical
                    const phaseName = cb.getAttribute('data-phase');
                    const taskObj = globalAIPhases[pIndex].tasks[tIndex];

                    let description = `[${phaseName}] ${taskObj.description || ''}`;
                    if (taskObj.checklist && taskObj.checklist.length > 0) {
                        description += `\n\nâœ… ì²´í¬ë¦¬ìŠ¤íŠ¸:\n` + taskObj.checklist.map(s => `- ${s}`).join('\n');
                    }

                    selectedTasks.push({
                        title: taskObj.title,
                        description: description,
                        estimated_days: taskObj.estimated_days,
                        is_milestone: taskObj.is_milestone
                    });
                } else {
                    // Flat (Legacy/Fallback)
                    const index = cb.id.replace('ai_task_', '');
                    selectedTasks.push(currentSuggestedTasks[index]);
                }
            }
        });

        document.getElementById('suggested_tasks_input').value = JSON.stringify(selectedTasks);
    }

    // Legacy support
    function displayWBSTasks(tasks) {
        currentSuggestedTasks = tasks;
        // Mock a phase structure for compatibility
        displayWBSPhases([{ phase_name: "ì œì•ˆëœ ì—…ë¬´", tasks: tasks }]);
    }
</script>
{% endblock %}

{% block modals %}

<!-- Project Modal -->
<div id="newProjectModal" style="z-index: 9999;"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">ìƒˆ í”„ë¡œì íŠ¸</h3>
            <button onclick="document.getElementById('newProjectModal').classList.add('hidden')"
                class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form action="/projects" method="post" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸ëª…</label>
                <input type="text" name="name" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>

            <!-- AI Task Suggestion Section -->
            <div class="border border-indigo-100 bg-indigo-50 rounded-lg p-4 mt-2 mb-2">
                <h4 class="font-bold text-indigo-800 text-sm mb-2 flex items-center">
                    <span class="mr-1">âœ¨</span> AI ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ ìë™ ì œì•ˆ
                </h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">í”„ë¡œì íŠ¸ ëª©í‘œ/ì‚°ì¶œë¬¼</label>
                        <textarea id="ai_goal" rows="2" placeholder="ì˜ˆ: ì¼ì •ê´€ë¦¬ ì›¹ 1ì°¨ ë°°í¬, ë””ìì¸ ë¦¬ë‰´ì–¼"
                            class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">ìœ í˜•</label>
                            <select id="ai_type" class="w-full border rounded-lg px-2 py-1.5 text-sm">
                                <option value="ê°œë°œ">ê°œë°œ</option>
                                <option value="ë§ˆì¼€íŒ…">ë§ˆì¼€íŒ…</option>
                                <option value="ìœ í†µ">ìœ í†µ</option>
                                <option value="í–‰ì‚¬">í–‰ì‚¬</option>
                                <option value="ì˜ì—…">ì˜ì—…</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">ë²”ìœ„</label>
                            <select id="ai_scope" class="w-full border rounded-lg px-2 py-1.5 text-sm">
                                <option value="í‘œì¤€">í‘œì¤€</option>
                                <option value="ê°„ë‹¨">ê°„ë‹¨</option>
                                <option value="í™•ì¥">í™•ì¥</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <span class="block text-xs font-semibold text-gray-600 mb-1">ì´í•´ê´€ê³„ì</span>
                        <div class="flex gap-3 text-sm">
                            <label class="flex items-center"><input type="checkbox" class="mr-1 ai-stakeholder"
                                    value="ê³ ê°">ê³ ê°</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-1 ai-stakeholder"
                                    value="ë‚´ë¶€" checked>ë‚´ë¶€</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-1 ai-stakeholder"
                                    value="ë²¤ë”">ë²¤ë”</label>
                        </div>
                    </div>
                    <button type="button" onclick="generateWBS()" id="btnGenerateWBS"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 rounded-lg transition flex justify-center items-center">
                        ë¦¬ìŠ¤íŠ¸ ì œì•ˆë°›ê¸°
                    </button>

                    <!-- Result Area -->
                    <div id="ai_result_area"
                        class="hidden mt-3 bg-white rounded border p-3 border-l-4 border-l-indigo-500">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-xs font-bold text-gray-700">ì¶”ê°€í•  ì—…ë¬´ ì„ íƒ</p>
                            <div class="text-xs space-x-1">
                                <button type="button" onclick="selectAllAI(true)"
                                    class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-600">ì „ì²´ ì„ íƒ</button>
                                <button type="button" onclick="selectCoreAI()"
                                    class="px-2 py-1 bg-indigo-50 hover:bg-indigo-100 rounded text-indigo-600 font-bold">í•µì‹¬ë§Œ
                                    ì„ íƒ</button>
                            </div>
                        </div>
                        <div id="ai_task_list" class="space-y-4 max-h-60 overflow-y-auto pr-1">
                            <!-- Tasks populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" name="suggested_tasks" id="suggested_tasks_input">

            <div class="grid grid-cols-2 gap-4">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ì—…ë¶€</label>
                    <select name="department" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="">ë¯¸ì§€ì •</option>
                        <option value="ì‹œìŠ¤í…œì‚¬ì—…ë¶€">ì‹œìŠ¤í…œì‚¬ì—…ë¶€</option>
                        <option value="ìœ í†µì‚¬ì—…ë¶€">ìœ í†µì‚¬ì—…ë¶€</option>
                        <option value="ê²½ì˜ì§€ì›íŒ€">ê²½ì˜ì§€ì›íŒ€</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì (ë‹¤ì¤‘ ì„ íƒ)</label>
                        <select name="assignee_ids" multiple class="w-full border rounded-lg px-3 py-2 text-sm h-24">
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                        <select name="status" class="w-full border rounded-lg px-3 py-2 text-sm">
                            <option value="Scheduled">ì˜ˆì •</option>
                            <option value="In Progress">ì§„í–‰ ì¤‘</option>
                            <option value="Completed">ì™„ë£Œ</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì›”</label>
                        <input type="month" name="start_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì›”</label>
                        <input type="month" name="end_date" class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ìƒì„±</button>
        </form>
    </div>
</div>

<!-- Edit Project Modal -->
<div id="editProjectModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center backdrop-blur-sm"
    style="z-index: 2147483647; display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; margin: 0; padding: 0;"
    onclick="if(event.target === this) { closeEditProjectModal(); }">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4"
        style="position: relative; z-index: 100000; min-width: 300px; min-height: 200px; max-height: 90vh; overflow-y: auto;"
        onclick="event.stopPropagation();">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">í”„ë¡œì íŠ¸ ìˆ˜ì •</h3>
            <button onclick="closeEditProjectModal();" class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        <form id="editProjectForm" method="post" action="" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸ëª…</label>
                <input type="text" name="name" id="edit_name" required
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                <textarea name="description" id="edit_description" rows="2"
                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ì—…ë¶€</label>
                    <select name="department" id="edit_department" class="w-full border rounded-lg px-3 py-2 text-sm">
                        <option value="">ë¯¸ì§€ì •</option>
                        <option value="ì‹œìŠ¤í…œì‚¬ì—…ë¶€">ì‹œìŠ¤í…œì‚¬ì—…ë¶€</option>
                        <option value="ìœ í†µì‚¬ì—…ë¶€">ìœ í†µì‚¬ì—…ë¶€</option>
                        <option value="ê²½ì˜ì§€ì›íŒ€">ê²½ì˜ì§€ì›íŒ€</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì (ë‹¤ì¤‘ ì„ íƒ)</label>
                        <select name="assignee_ids" id="edit_assignee_ids" multiple
                            class="w-full border rounded-lg px-3 py-2 text-sm h-24">
                            {% for u in users %}
                            <option value="{{ u.id }}">{{ u.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                        <select name="status" id="edit_status" class="w-full border rounded-lg px-3 py-2 text-sm">
                            <option value="Scheduled">ì˜ˆì •</option>
                            <option value="In Progress">ì§„í–‰ ì¤‘</option>
                            <option value="Completed">ì™„ë£Œ</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì‹œì‘ì›”</label>
                        <input type="month" name="start_date" id="edit_start_date"
                            class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ì¢…ë£Œì›”</label>
                        <input type="month" name="end_date" id="edit_end_date"
                            class="w-full border rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>

                <!-- File Management Section -->
                <div class="border-t pt-2 mt-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì²¨ë¶€ íŒŒì¼</label>

                    <!-- Existing Files List -->
                    <div id="existingFilesList" class="space-y-1 mb-3 text-sm text-gray-600">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Note: File upload is handled separately via uploadForm -->
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="button" id="updateBtn"
                        class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">ì €ì¥</button>
                    <!-- Link separate delete logic manually or via js logic -->
                    <button type="button"
                        onclick="if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { document.getElementById('deleteProjectForm').submit(); }"
                        class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition">ì‚­ì œ</button>
                </div>
        </form>
        <!-- Hidden Delete Form (Helper) -->
        <form id="deleteProjectForm" method="post" action="">
        </form>
    </div>
</div>

<!-- Project Tasks Modal -->
<div id="projectTasksModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center backdrop-blur-sm"
    style="z-index: 9999;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 pb-2 border-b">
            <h3 class="text-xl font-bold text-gray-800" id="projectTasksModalTitle">í”„ë¡œì íŠ¸ ì—…ë¬´ ëª©ë¡</h3>
            <button onclick="closeProjectTasksModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>

        <div class="overflow-y-auto flex-1">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b sticky top-0">
                    <tr>
                        <th scope="col" class="px-6 py-3">ìƒíƒœ</th>
                        <th scope="col" class="px-6 py-3">ì—…ë¬´ëª…</th>
                        <th scope="col" class="px-6 py-3">ë‹´ë‹¹ì</th>
                        <th scope="col" class="px-6 py-3">ë§ˆê°ì¼</th>
                    </tr>
                </thead>
                <tbody id="projectTasksList">
                    <!-- Tasks will be populated here -->
                </tbody>
            </table>
            <div id="projectTasksLoading" class="hidden text-center py-4">
                <p>ë¡œë”© ì¤‘...</p>
            </div>
            <div id="projectTasksEmpty" class="hidden text-center py-4 text-gray-400">
                <p>ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div class="mt-4 pt-2 border-t text-right">
            <a href="#" id="projectTasksDashboardLink"
                class="text-blue-600 hover:text-blue-800 text-sm font-medium">ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ê¸° â†’</a>
        </div>
    </div>
</div>
{% endblock %}